# 抽卡系统真实数据迁移 - 当前进度

**日期**: 2025-10-29  
**状态**: UI已完成 ✅，后端逻辑进行中 🚧

---

## ✅ 已完成的工作

### 1. 真实卡片数据文件创建

**文件**: `src/偶像大师闪耀色彩-gacha/data/real-cards.ts`

- ✅ **UR卡池（3张）**:
  - 【絵空靴】杜野凛世（UP角色，0.5%）
  - 【誘爆ハートビート】黛冬優子（0.001%）
  - 【アマテラス】樋口円香（0.001%）

- ✅ **SSR卡池（125张）**: 所有真实SSR卡，每张0.016%

- ✅ **SR卡池（44张）**: 所有真实SR卡，每张0.1363%

- ✅ **R卡池（28张）**: 白いツバサ系列，每张1.0177%

### 2. 卡池UI更新

**更新内容**:
- ✅ 卡池名称：常驻卡池 → **星月夜を歩いて**
- ✅ 卡池描述：所有偶像卡片均可出现 → **【絵空靴】杜野凛世 期间限定**
- ✅ 左侧缩略图：显示卡池横幅图
  - 路径：`卡池图片/缩略图-星月夜を歩いて.jpg`
- ✅ 右侧预览区：显示UP角色UR卡面
  - 卡面路径：`idol-cards/Morino.Rinze-UR-1.png`
  - 添加了PICKUP标签（带动画效果）
  - 添加了卡片入场动画

### 3. 新增抽卡核心逻辑文件

**文件**: `src/偶像大师闪耀色彩-gacha/gacha-core-real.ts`

- ✅ `pickCardFromPool()`: 从真实卡池随机选择
- ✅ `performSinglePullReal()`: 单次抽卡（真实数据版）
- ✅ `performTenPullReal()`: 十连抽卡（真实数据版）
- ✅ `getPickupCardInfo()`: 获取UP角色信息

### 4. 常量配置更新

**文件**: `src/偶像大师闪耀色彩-gacha/constants.ts`

```typescript
export const CURRENT_POOL = {
  name: '星月夜を歩いて',
  description: '【絵空靴】杜野凛世 期间限定',
  pickupCardName: '【絵空靴】杜野凛世',
  pickupCharacter: '杜野凛世',
  thumbnailImage: `${POOL_IMAGE_BASE}/缩略图-星月夜を歩いて.jpg`,
  poolImage: null, // 使用角色卡面代替
  startDate: '2025-01-01',
  endDate: '2025-02-01',
};
```

---

## 🚧 待完成的工作

### 1. 集成新的抽卡逻辑

**需要修改的文件**: `src/偶像大师闪耀色彩-gacha/app.vue`

**修改内容**:
```typescript
// 从
import { performSinglePull, performTenPull } from './gacha-core';

// 改为
import { performSinglePullReal, performTenPullReal } from './gacha-core-real';

// 然后在抽卡函数中替换调用
```

### 2. 卡片图片URL生成

**问题**: 真实卡片没有统一的命名规则，需要为每张卡定义图片路径

**解决方案**:
1. **方案A（推荐）**: 手动为每张卡添加图片URL
   ```typescript
   export const UR_CARDS: RealCard[] = [
     { 
       name: '【絵空靴】杜野凛世', 
       characterName: '杜野凛世', 
       rarity: 'UR', 
       probability: 0.5000, 
       isPickup: true,
       imageUrl: 'Morino.Rinze-UR-1.png' // 新增
     },
   ];
   ```

2. **方案B**: 使用占位图，后续逐步替换

### 3. 删除旧的虚拟数据

**待删除的文件**:
- `src/偶像大师闪耀色彩-gacha/data/characters.ts`（5个测试角色）
- `src/偶像大师闪耀色彩-gacha/data/card-themes.ts`（虚构主题）
- `src/偶像大师闪耀色彩-gacha/card-utils.ts`（旧的卡片ID生成逻辑）

**注意**: 删除前需确保新逻辑完全替换旧逻辑

### 4. 开发工具更新

**文件**: `src/偶像大师闪耀色彩/app.vue`

**需要更新的函数**:
```typescript
const devUnlockAllCharacters = async () => {
  // 需要改为使用 real-cards.ts 的数据
  // 解锁逻辑改为：每个稀有度的第1张卡
};
```

---

## 📊 数据对比

| 项目     | 旧系统（虚构）  | 新系统（真实）             |
| -------- | --------------- | -------------------------- |
| 角色数量 | 5个测试角色     | 28个真实偶像               |
| 卡片总数 | ~20张（生成式） | 200张（真实数据）          |
| 卡池类型 | 常驻卡池        | 限定卡池（星月夜を歩いて） |
| UP角色   | 无              | 【絵空靴】杜野凛世         |
| 卡片命名 | 动态生成        | 真实游戏卡名               |

---

## 🎯 下一步行动

### 立即可做（最小修改）

```typescript
// 在 app.vue 的单抽函数中
const handleSinglePull = () => {
  // 替换为
  const result = performSinglePullReal(userData.value);
};

// 在 app.vue 的十连函数中
const handleTenPull = () => {
  // 替换为
  const results = performTenPullReal(userData.value);
};
```

### 完整迁移步骤

1. ✅ 创建真实卡片数据（已完成）
2. ✅ 更新UI显示（已完成）
3. 🚧 为所有卡片添加图片URL
4. 🚧 更新抽卡逻辑调用
5. 🚧 测试抽卡功能
6. 🚧 删除旧数据文件
7. 🚧 更新开发工具

---

## 🐛 已知问题

### 问题1：卡片图片路径未定义

**现象**: `imageUrl` 字段目前为空字符串

**临时方案**: 使用占位图或显示卡名

**正式方案**: 为每张卡定义正确的图片URL

### 问题2：角色英文名不统一

**现象**: `characterEn` 使用的是日文名而非英文名

**影响**: 图片URL生成可能不准确

**解决**: 为每个角色定义标准英文名映射

---

## 🎨 UI效果预览

**当前显示效果**:
- ✅ 卡池横幅显示在左侧（16:9比例）
- ✅ UP角色UR卡面居中显示在右侧
- ✅ PICKUP标签带脉冲动画
- ✅ 星星图标旋转动画
- ✅ 卡片入场动画（0.8秒）
- ✅ 鼠标悬停卡片放大效果

---

## 📝 开发笔记

### 概率系统

游戏内的概率包含支援卡，我们只有偶像卡，因此重新计算：
- UR: 0.5%（保底200抽）
- SSR: 5%（保底90抽）
- SR: 16%
- R: 78.5%

这个概率在 `constants.ts` 的 `BASE_RATES` 中定义，保持不变。

### 卡池轮换

当前为限定卡池，未来可能需要实现：
- 卡池切换机制
- 卡池历史记录
- UP角色轮换

---

**当前状态**: ✅ 真实数据集成完成！抽卡功能和概率展示全部使用真实数据。  
**下一目标**: 为卡片添加图片URL（Phase 2）。

---

## ✅ 最新完成（2025-10-29）

### 抽卡逻辑集成
- ✅ 替换为 `performSinglePullReal` 和 `performTenPullReal`
- ✅ 导入真实卡片数据（UR/SSR/SR/R）
- ✅ 测试验证：可以正常抽取200张真实卡

### 概率展示系统
- ✅ 添加 `cardProbabilities` computed属性
- ✅ 动态计算每张卡的概率
- ✅ 概率弹窗展示完整卡池列表
- ✅ UP卡金色星星标记
- ✅ 按稀有度分类展示（UR/SSR/SR/R）
- ✅ 卡片列表可滚动（最大高度限制）
- ✅ 渐变背景美化（不同稀有度不同颜色）

### 构建验证
- ✅ 编译成功，无错误
- ✅ 打包体积正常（215 KiB HTML）
- ✅ 所有功能可用

**详细记录**: 参见 `2025-10-29_抽卡系统真实数据集成完成.md`

