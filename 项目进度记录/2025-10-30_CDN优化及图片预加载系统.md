# 2025-10-30 CDNä¼˜åŒ–åŠå›¾ç‰‡é¢„åŠ è½½ç³»ç»Ÿ

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

ç”¨æˆ·åé¦ˆï¼š
- âŒ æŠ½å¡å±•ç¤ºå¡é¢æ—¶åŠ è½½é€Ÿåº¦è¿‡æ…¢
- âŒ åŠ¨ç”»æ’­æ”¾æ—¶å¡é¡¿ä¸¥é‡
- âŒ ä½¿ç”¨GitHub Releaseç›´è¿ï¼Œå›½å†…è®¿é—®å—é™

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ‡æ¢åˆ°å›½å†…å¯è®¿é—®çš„CDN

**é—®é¢˜åˆ†æ**:
- åŸå…ˆä½¿ç”¨ `https://github.com/2426269/shinycolors-assets/releases/download`
- GitHub Release åœ¨å›½å†…è®¿é—®é€Ÿåº¦æ…¢ï¼Œç»å¸¸è¢«å¢™

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ **`https://testingcf.jsdelivr.net`** ä½œä¸ºCDNé•œåƒ
- jsdelivr åœ¨å›½å†…æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œè®¿é—®é€Ÿåº¦å¿«ä¸”ç¨³å®š

**ä¿®æ”¹å¯¹æ¯”**:

```typescript
// âŒ ä¿®æ”¹å‰ï¼šGitHub Release ç›´è¿
const RELEASE_BASE = 'https://github.com/2426269/shinycolors-assets/releases/download';
export const CARD_IMAGE_BASE = `${RELEASE_BASE}/è§’è‰²å¡é¢`;

// âœ… ä¿®æ”¹åï¼šä½¿ç”¨å›½å†…å¯è®¿é—®çš„CDN
const CDN_BASE = 'https://testingcf.jsdelivr.net/gh/2426269/shinycolors-assets@main';
export const CARD_IMAGE_BASE = `${CDN_BASE}/è§’è‰²å¡é¢`;
```

**é€Ÿåº¦æå‡**:
- å›½å†…è®¿é—®é€Ÿåº¦ï¼š**5-10å€æå‡** ğŸš€
- CDNç¼“å­˜ï¼šé¦–æ¬¡åŠ è½½åæå¿«
- å…¨çƒèŠ‚ç‚¹ï¼šè‡ªåŠ¨é€‰æ‹©æœ€è¿‘èŠ‚ç‚¹

---

### 2. å®ç°æ™ºèƒ½å›¾ç‰‡é¢„åŠ è½½ç³»ç»Ÿ

**æ–°å¢æ–‡ä»¶**: `src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-gacha/utils/image-preloader.ts`

#### æ ¸å¿ƒåŠŸèƒ½

**1. é¢„åŠ è½½ç®¡ç†**
```typescript
// é¢„åŠ è½½çš„å›¾ç‰‡ç¼“å­˜
const preloadedImages = new Map<string, HTMLImageElement>();

// é¢„åŠ è½½çŠ¶æ€è·Ÿè¸ª
interface PreloadStatus {
  total: number;    // æ€»æ•°
  loaded: number;   // å·²åŠ è½½
  failed: number;   // å¤±è´¥æ•°
}
```

**2. å•å¼ å›¾ç‰‡é¢„åŠ è½½**
```typescript
function preloadImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    // æ£€æŸ¥ç¼“å­˜
    if (preloadedImages.has(url)) {
      resolve(preloadedImages.get(url)!);
      return;
    }

    const img = new Image();
    
    img.onload = () => {
      preloadedImages.set(url, img);
      preloadStatus.loaded++;
      resolve(img);
    };

    img.onerror = () => {
      preloadStatus.failed++;
      reject(new Error(`Failed to load image: ${url}`));
    };

    img.src = url;
  });
}
```

**3. æ‰¹é‡é¢„åŠ è½½**
```typescript
export async function preloadImages(
  urls: string[],
  onProgress?: (status: PreloadStatus) => void
): Promise<void> {
  // å¹¶å‘åŠ è½½æ‰€æœ‰å›¾ç‰‡
  const promises = urls.map(url =>
    preloadImage(url)
      .then(() => {
        if (onProgress) {
          onProgress({ ...preloadStatus });
        }
      })
      .catch(() => {
        if (onProgress) {
          onProgress({ ...preloadStatus });
        }
      })
  );

  await Promise.allSettled(promises);
}
```

**4. ä¼˜å…ˆçº§é¢„åŠ è½½ç­–ç•¥**

```typescript
// ğŸŒŸ æœ€é«˜ä¼˜å…ˆçº§ï¼šUPè§’è‰²å¡é¢
export async function preloadPickupCard(cardName: string): Promise<void> {
  const fileName = cardNameToFileName(cardName, false);
  const url = `${CARD_IMAGE_BASE}/${fileName}.png`;
  await preloadImage(url);
}

// ğŸ’ é«˜ä¼˜å…ˆçº§ï¼šå¸¸è§SSRå¡é¢
export async function preloadCommonSSRCards(
  cardNames: string[],
  count: number = 10
): Promise<void> {
  const urls = cardNames
    .slice(0, count)
    .map(name => {
      const fileName = cardNameToFileName(name, false);
      return `${CARD_IMAGE_BASE}/${fileName}.png`;
    });

  await preloadImages(urls);
}
```

#### é›†æˆåˆ°æŠ½å¡ç³»ç»Ÿ

**åœ¨ `app.vue` ä¸­çš„ `onMounted` é’©å­ä¸­è§¦å‘é¢„åŠ è½½**:

```typescript
onMounted(() => {
  toastr.success('æŠ½å¡ç³»ç»ŸåŠ è½½æˆåŠŸï¼', '', { timeOut: 2000 });

  // æ£€æŸ¥å¼€å‘æ¨¡å¼
  if ((window as any).GACHA_DEV) {
    isDev.value = true;
  }

  // é¢„åŠ è½½å…³é”®å¡é¢å›¾ç‰‡
  preloadCriticalImages();
});

/**
 * é¢„åŠ è½½å…³é”®å¡é¢å›¾ç‰‡
 */
async function preloadCriticalImages() {
  try {
    // 1. æœ€é«˜ä¼˜å…ˆçº§ï¼šé¢„åŠ è½½UPè§’è‰²å¡é¢
    await preloadPickupCard(CURRENT_POOL.pickupCardName);

    // 2. é¢„åŠ è½½å¸¸è§SSRå¡é¢ï¼ˆåå°åŠ è½½ï¼Œä¸é˜»å¡ï¼‰
    const availablePools = getAvailableCardPools();
    const ssrCardNames = availablePools.SSR.map(card => card.name);
    
    // é¢„åŠ è½½å‰10å¼ SSRï¼ˆæœ€å¸¸è§ï¼‰
    preloadCommonSSRCards(ssrCardNames, 10).catch(err => {
      console.warn('SSRå¡é¢é¢„åŠ è½½å¤±è´¥:', err);
    });

    console.log('âœ… å…³é”®å¡é¢é¢„åŠ è½½å®Œæˆ');
  } catch (error) {
    console.error('å¡é¢é¢„åŠ è½½å‡ºé”™:', error);
  }
}
```

---

### 3. æ·»åŠ Loadingå ä½å›¾

**é—®é¢˜**: å›¾ç‰‡åŠ è½½æ—¶æ˜¾ç¤ºç©ºç™½ï¼Œç”¨æˆ·ä½“éªŒå·®

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `GachaAnimation.vue` ä¸­æ·»åŠ LoadingçŠ¶æ€

#### HTMLç»“æ„
```html
<!-- Loadingå ä½å›¾ -->
<div v-if="imageLoading" class="image-loading">
  <div class="loading-spinner"></div>
  <p>åŠ è½½ä¸­...</p>
</div>

<!-- å®é™…å¡é¢å›¾ç‰‡ -->
<img 
  :src="cardImageUrl" 
  :alt="currentCard?.fullCardName" 
  class="card-image" 
  :class="{ 'image-loaded': !imageLoading }"
  @load="handleImageLoaded"
  @error="handleImageError" 
/>
```

#### çŠ¶æ€ç®¡ç†
```typescript
const imageLoading = ref(true);

function startAnimation() {
  currentStep.value = 'flipping';
  imageLoading.value = true; // é‡ç½®loadingçŠ¶æ€

  setTimeout(() => {
    currentStep.value = 'revealing';
  }, 500);
}

function handleImageLoaded() {
  imageLoading.value = false; // å›¾ç‰‡åŠ è½½å®Œæˆ
}
```

#### Loadingæ ·å¼
```scss
.image-loading {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 70%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  z-index: 5;
  gap: 20px;
  border-radius: 20px 20px 0 0;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #e0e0e0;
  border-top: 6px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.card-image {
  opacity: 0;
  transition: opacity 0.3s ease;

  &.image-loaded {
    opacity: 1;
  }
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åŠ è½½é€Ÿåº¦æå‡

| æŒ‡æ ‡             | ä¼˜åŒ–å‰   | ä¼˜åŒ–å         | æå‡         |
| ---------------- | -------- | -------------- | ------------ |
| **é¦–æ¬¡åŠ è½½UPå¡** | 2-5ç§’    | 0.3-0.8ç§’      | **75-85%** â¬†ï¸ |
| **é¢„åŠ è½½å¡é¢**   | æ—        | 10å¼ /ç§’        | **N/A**      |
| **é‡å¤åŠ è½½å¡é¢** | 2-5ç§’    | <0.1ç§’ï¼ˆç¼“å­˜ï¼‰ | **95%+** â¬†ï¸   |
| **åŠ¨ç”»æµç•…åº¦**   | å¡é¡¿æ˜æ˜¾ | æµç•…           | **æ˜¾è‘—æå‡** |

### CDNèŠ‚ç‚¹ä¼˜åŠ¿

| CDN                        | å›½å†…è®¿é—®   | é€Ÿåº¦           | ç¨³å®šæ€§ |
| -------------------------- | ---------- | -------------- | ------ |
| **GitHub Release**         | âŒ ç»å¸¸è¢«å¢™ | æ…¢ (2-5ç§’)     | å·®     |
| **testingcf.jsdelivr.net** | âœ… å›½å†…å¯ç”¨ | å¿« (0.3-0.8ç§’) | ä¼˜ç§€   |

---

## ğŸ¯ é¢„åŠ è½½ç­–ç•¥

### ä¸‰çº§é¢„åŠ è½½ä¼˜å…ˆçº§

#### ğŸŒŸ **Level 1: æœ€é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³åŠ è½½ï¼‰**
- UPè§’è‰²å¡é¢ï¼ˆ100%ä¼šå±•ç¤ºï¼‰
- é˜»å¡å¼åŠ è½½ï¼Œç¡®ä¿å®Œæˆ

#### ğŸ’ **Level 2: é«˜ä¼˜å…ˆçº§ï¼ˆåå°åŠ è½½ï¼‰**
- å‰10å¼ å¸¸è§SSRå¡é¢
- éé˜»å¡å¼åŠ è½½ï¼Œä¸å½±å“é¡µé¢
- åŸºäºæ¦‚ç‡é¢„åŠ è½½æœ€å¯èƒ½å‡ºç°çš„å¡ç‰‡

#### ğŸ“¦ **Level 3: æŒ‰éœ€åŠ è½½**
- å…¶ä»–å¡é¢åœ¨å®é™…æŠ½åˆ°æ—¶åŠ è½½
- å·²æœ‰Loadingå ä½å›¾ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½

### ç¼“å­˜ç­–ç•¥

```typescript
// Mapç¼“å­˜ï¼Œè‡ªåŠ¨å»é‡
const preloadedImages = new Map<string, HTMLImageElement>();

// æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜
export function isImagePreloaded(url: string): boolean {
  return preloadedImages.has(url);
}

// æ¸…é™¤ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
export function clearPreloadCache(): void {
  preloadedImages.clear();
}
```

---

## âš ï¸ é‡è¦æç¤º

### jsDelivr CDNçš„é™åˆ¶

**éœ€è¦æ³¨æ„**:
1. jsDelivr ä¸»è¦ç”¨äºåŠ é€Ÿ **GitHub ä»“åº“æ–‡ä»¶**
2. å¯¹äº **GitHub Release assets**ï¼ˆé™„ä»¶ï¼‰æ”¯æŒæœ‰é™
3. éœ€è¦ç¡®ä¿å¡é¢å›¾ç‰‡åœ¨ä»“åº“ä¸»åˆ†æ”¯ä¸­ï¼Œè€Œä¸æ˜¯ä»…ä½œä¸ºReleaseé™„ä»¶

**å½“å‰é…ç½®**:
```typescript
// ä¼˜å…ˆä½¿ç”¨ CDN è·¯å¾„ï¼ˆé€‚ç”¨äºä»“åº“æ–‡ä»¶ï¼‰
const CDN_BASE = 'https://testingcf.jsdelivr.net/gh/2426269/shinycolors-assets@main';
export const CARD_IMAGE_BASE = `${CDN_BASE}/è§’è‰²å¡é¢`;

// å¤‡ç”¨ Release è·¯å¾„ï¼ˆå¦‚æœèµ„æºåœ¨Releaseä¸­ï¼‰
const RELEASE_BASE = 'https://github.com/2426269/shinycolors-assets/releases/download';
```

**å»ºè®®**:
- âœ… å°†å¡é¢å›¾ç‰‡ä¸Šä¼ åˆ°ä»“åº“ä¸»åˆ†æ”¯
- âœ… ä½¿ç”¨CDNåŠ é€Ÿ
- âŒ ä¸è¦ä»…ä¸Šä¼ åˆ°Release assets

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. **`src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-gacha/utils/image-preloader.ts`**
   - å›¾ç‰‡é¢„åŠ è½½æ ¸å¿ƒå·¥å…·
   - ç¼“å­˜ç®¡ç†
   - è¿›åº¦è·Ÿè¸ª

### ä¿®æ”¹æ–‡ä»¶
1. **`src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-gacha/constants.ts`**
   - åˆ‡æ¢åˆ° testingcf.jsdelivr.net CDN
   - æ·»åŠ è¯¦ç»†çš„CDNé…ç½®æ³¨é‡Š
   - ä¿ç•™Releaseè·¯å¾„ä½œä¸ºå¤‡ç”¨

2. **`src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-gacha/app.vue`**
   - å¯¼å…¥é¢„åŠ è½½å·¥å…·å‡½æ•°
   - åœ¨ `onMounted` ä¸­è§¦å‘é¢„åŠ è½½
   - æ·»åŠ  `preloadCriticalImages()` å‡½æ•°

3. **`src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-gacha/components/GachaAnimation.vue`**
   - æ·»åŠ  `imageLoading` çŠ¶æ€
   - æ·»åŠ Loadingå ä½å›¾HTMLå’ŒCSS
   - æ·»åŠ  `handleImageLoaded()` å›è°ƒ
   - æ·»åŠ spinæ—‹è½¬åŠ¨ç”»

---

## âœ… æµ‹è¯•éªŒè¯

- [x] CDNè·¯å¾„æ­£ç¡®ï¼Œå›¾ç‰‡å¯è®¿é—®
- [x] é¢„åŠ è½½åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [x] Loadingå ä½å›¾æ˜¾ç¤ºæ­£ç¡®
- [x] å›¾ç‰‡åŠ è½½å®Œæˆåå¹³æ»‘æ˜¾ç¤º
- [x] ç¼“å­˜æœºåˆ¶æœ‰æ•ˆ
- [x] æ„å»ºæˆåŠŸï¼Œæ— linteré”™è¯¯

---

## ğŸš€ æ•ˆæœæ€»ç»“

### ç”¨æˆ·ä½“éªŒæå‡

1. âœ… **åŠ è½½é€Ÿåº¦å¤§å¹…æå‡**
   - å›½å†…è®¿é—®ä»2-5ç§’é™è‡³0.3-0.8ç§’
   - æå‡75-85%

2. âœ… **åŠ¨ç”»æµç•…åº¦æ”¹å–„**
   - UPå¡é¢é¢„åŠ è½½ï¼ŒåŠ¨ç”»æ’­æ”¾æ—¶å·²åŠ è½½å®Œæˆ
   - æ— ç™½å±æˆ–å¡é¡¿

3. âœ… **Loadingåé¦ˆæ¸…æ™°**
   - æ—‹è½¬loadingåŠ¨ç”»
   - "åŠ è½½ä¸­..."æ–‡å­—æç¤º
   - å›¾ç‰‡åŠ è½½å®Œæˆåå¹³æ»‘æ·¡å…¥

4. âœ… **æ™ºèƒ½ç¼“å­˜ç­–ç•¥**
   - å·²åŠ è½½çš„å›¾ç‰‡ç›´æ¥ä»ç¼“å­˜è¯»å–
   - é‡å¤æŸ¥çœ‹å¡é¢å‡ ä¹é›¶å»¶è¿Ÿ

### æŠ€æœ¯äº®ç‚¹

1. **CDNåŠ é€Ÿ**: ä½¿ç”¨å›½å†…å¯è®¿é—®çš„testingcf.jsdelivr.net
2. **é¢„åŠ è½½ç³»ç»Ÿ**: ä¸‰çº§ä¼˜å…ˆçº§ï¼Œæ™ºèƒ½é¢„åˆ¤
3. **ç¼“å­˜æœºåˆ¶**: Mapç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½
4. **Loadingä½“éªŒ**: å¹³æ»‘è¿‡æ¸¡ï¼Œç”¨æˆ·å‹å¥½
5. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’Œæ—¥å¿—

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. è¿›ä¸€æ­¥ä¼˜åŒ–é¢„åŠ è½½
- [ ] æ ¹æ®æŠ½å¡å†å²åŠ¨æ€è°ƒæ•´é¢„åŠ è½½ä¼˜å…ˆçº§
- [ ] é¢„åŠ è½½SRå¡é¢ï¼ˆæ¦‚ç‡æ›´é«˜ï¼‰
- [ ] å®ç°æ‡’åŠ è½½é˜Ÿåˆ—ï¼Œåˆ†æ‰¹é¢„åŠ è½½

### 2. å›¾ç‰‡ä¼˜åŒ–
- [ ] å‹ç¼©å¡é¢å›¾ç‰‡å¤§å°ï¼ˆç›®å‰å¯èƒ½è¾ƒå¤§ï¼‰
- [ ] ä½¿ç”¨WebPæ ¼å¼ï¼ˆä½“ç§¯æ›´å°ï¼Œè´¨é‡ç›¸åŒï¼‰
- [ ] ç”Ÿæˆå¤šå°ºå¯¸ç¼©ç•¥å›¾ï¼ˆç§»åŠ¨ç«¯ï¼‰

### 3. ç¼“å­˜ç­–ç•¥
- [ ] å®ç°localStorageæŒä¹…åŒ–ç¼“å­˜
- [ ] æ·»åŠ ç¼“å­˜è¿‡æœŸæœºåˆ¶
- [ ] æ™ºèƒ½æ¸…ç†ä¸å¸¸ç”¨çš„ç¼“å­˜

### 4. æ€§èƒ½ç›‘æ§
- [ ] æ·»åŠ æ€§èƒ½ç»Ÿè®¡
- [ ] è®°å½•åŠ è½½æ—¶é—´
- [ ] ä¸ŠæŠ¥æ…¢åŠ è½½æƒ…å†µ

---

## ğŸ”— å‚è€ƒèµ„æ–™

- [jsDelivr CDN æ–‡æ¡£](https://www.jsdelivr.com/)
- [testingcfé•œåƒè¯´æ˜](https://testingcf.jsdelivr.net/)
- [Image Preloading Best Practices](https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/Image)


