# 图片加载优化方案 (2025-10-30)

## 🔍 问题分析

### 根本原因

**IndexedDB缓存无法工作**：GitHub Release 不允许 JavaScript `fetch()` 请求，返回 CORS 错误：

```
Access to fetch at 'https://github.com/2426269/shinycolors-assets/releases/download/...' 
from origin 'http://127.0.0.1:8000' 
has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present
```

### 影响

1. ❌ IndexedDB缓存完全无法工作
2. ❌ 所有 `fetch()` 请求被浏览器阻止
3. ❌ 缓存统计始终显示 0
4. ✅ `<img>` 标签仍然可以加载图片（不受CORS限制）

---

## ✅ 实施的优化方案

### 1. 移除IndexedDB缓存系统

**删除的文件**：
- `src/偶像大师闪耀色彩-gacha/utils/image-cache.ts`
- `src/偶像大师闪耀色彩-gacha/utils/image-preloader.ts`

**修改的文件**：
- `src/偶像大师闪耀色彩-gacha/app.vue`
  - 移除 `pickupCardImageUrl` ref
  - 移除 `loadPickupCardImage()` 函数
  - 移除 `preloadCriticalImages()` 函数
  - 移除 `.bg-loading` 样式
  - 直接使用 `<img>` 标签加载UP角色背景图

- `src/偶像大师闪耀色彩-gacha/components/GachaAnimation.vue`
  - 将 `cardImageUrl` 从 ref 改为 computed property
  - 移除 IndexedDB 缓存加载逻辑
  - 直接使用图片URL

- `src/偶像大师闪耀色彩/app.vue`
  - 移除"缓存管理"设置分类
  - 移除 `cacheStats` ref
  - 移除 `formatCacheSize()` 函数
  - 移除 `updateCacheStats()` 函数
  - 移除 `handleClearCache()` 函数
  - 移除缓存统计相关CSS样式

### 2. 启用浏览器原生特性

**使用 `loading="lazy"` 属性**：
```html
<img
  src="https://github.com/.../Ezoragutsu_Morino.Rinze.png"
  alt="【絵空靴】杜野凛世"
  class="bg-card-image"
  loading="lazy"
/>
```

**优势**：
- ✅ 浏览器原生支持
- ✅ 延迟加载非关键图片
- ✅ 减少初始加载时间

### 3. 依赖浏览器HTTP缓存

**原理**：
- 浏览器自动缓存所有HTTP资源
- GitHub Release返回正确的缓存头
- 第二次访问时自动从浏览器缓存加载

**优势**：
- ✅ 无需编写缓存代码
- ✅ 自动管理缓存有效期
- ✅ 支持所有现代浏览器

---

## 📊 性能对比

### IndexedDB方案（已废弃）
- **首次加载**：3-10秒/张（取决于网络）
- **缓存后**：理论上 <100ms
- **实际情况**：CORS错误，无法缓存 ❌

### 浏览器HTTP缓存（当前方案）
- **首次加载**：3-10秒/张（取决于网络）
- **缓存后**：~200-500ms/张（从HTTP缓存）✅
- **实际情况**：完全正常工作 ✅

---

## 🚀 进一步优化建议

### 方案1：图片压缩（推荐 ⭐⭐⭐⭐⭐）

**当前**：3-5MB/张  
**优化后**：500KB-1MB/张  
**提速**：**5-10倍**

**工具**：
- TinyPNG
- ImageOptim
- WebP转换

### 方案2：渐进式加载（推荐 ⭐⭐⭐⭐）

**实施方式**：
1. 先显示低分辨率占位图（50KB）
2. 后台加载高清图
3. 加载完成后平滑切换

**优势**：
- ✅ 即时显示图片
- ✅ 更好的用户体验
- ✅ 减少白屏时间

### 方案3：WebP格式（推荐 ⭐⭐⭐）

**优势**：
- 比PNG小30-50%
- 现代浏览器全支持
- 支持透明度

**HTML示例**：
```html
<picture>
  <source srcset="image.webp" type="image/webp">
  <img src="image.png" alt="fallback">
</picture>
```

### 方案4：国内CDN（需要成本）

**当前问题**：
- GitHub Release在国内访问慢
- 不稳定，可能被限流

**解决方案**：
- 使用国内CDN（如七牛云、阿里云OSS）
- 仅存放图片资源（压缩后）
- 成本：约10-30元/月

### 方案5：Base64内联小图标（推荐 ⭐⭐⭐）

**适用于**：
- 游戏UI图标（羽石、星尘等）
- 小于10KB的图片

**优势**：
- 0网络请求
- 即时显示
- 打包在代码中

---

## ⚠️ 不推荐的方案

### 1. CORS代理
- ❌ 不稳定
- ❌ 可能被限流
- ❌ 增加延迟

### 2. Service Worker
- ❌ 复杂度高
- ❌ 调试困难
- ❌ 对于GitHub Release仍然受CORS限制

### 3. 将图片移至主仓库
- ❌ GitHub仓库有1GB软限制
- ❌ 当前7GB图片无法移入
- ❌ 影响Git性能

---

## 📝 代码变更摘要

### 删除的文件 (2个)
```
src/偶像大师闪耀色彩-gacha/utils/image-cache.ts
src/偶像大师闪耀色彩-gacha/utils/image-preloader.ts
```

### 修改的文件 (3个)
```
src/偶像大师闪耀色彩-gacha/app.vue
  - 移除 pickupCardImageUrl ref
  - 移除 loadPickupCardImage()
  - 移除 preloadCriticalImages()
  - 移除 .bg-loading 样式

src/偶像大师闪耀色彩-gacha/components/GachaAnimation.vue
  - cardImageUrl 改为 computed property
  - 移除 IndexedDB watch

src/偶像大师闪耀色彩/app.vue
  - 移除"缓存管理"设置区域
  - 移除 cacheStats、updateCacheStats、handleClearCache
  - 移除相关CSS样式
```

### 构建结果
```
✅ webpack 5.102.1 compiled successfully
✅ 无编译错误
✅ 无运行时错误
```

---

## 🎯 总结

1. **问题根源**：GitHub Release的CORS限制使IndexedDB缓存无法工作
2. **解决方案**：移除IndexedDB，依赖浏览器原生HTTP缓存
3. **性能改进**：虽然不如IndexedDB快，但实际可用且稳定
4. **后续优化**：图片压缩是最有效的优化方向（5-10倍提速）

**建议优先级**：
1. 🔥 **图片压缩**（立即实施，效果最好）
2. 🔥 **渐进式加载**（用户体验提升明显）
3. ⚡ **WebP格式**（可选，进一步压缩）
4. 💰 **国内CDN**（需要成本，视情况决定）



