# 2025-10-30 抽卡系统卡面罗马音化及动画实现

## 📋 任务概览

完成了抽卡系统的重大重构，包括卡面文件罗马音化、抽卡动画系统以及卡面使用规则的明确化。

## ✅ 已完成工作

### 1. 卡面文件重命名（罗马音化）

**目的**: 解决GitHub Release对非ASCII字符文件名的限制

**实现**:
- 创建了批量重命名脚本，将所有281个卡面文件从日文命名转换为罗马音命名
- 命名规则：
  - 未觉醒卡面：`主题罗马音_角色罗马音.png`
  - 觉醒卡面：`主题罗马音_角色罗马音+.png`
- 示例：
  - `【絵空靴】杜野凛世.PNG` → `Ezoragutsu_Morino.Rinze.png`
  - `【絵空靴】杜野凛世+.PNG` → `Ezoragutsu_Morino.Rinze+.png`

**统计**:
- ✅ 成功重命名：281个文件
- ❌ 失败：0个

### 2. 卡面使用规则明确化

**新规则**:
1. **日常展示（未觉醒卡面）**:
   - 抽卡动画中的卡面展示
   - 抽卡结果的缩略图展示
   - 卡池预览的角色卡面
   - 所有UI界面的卡片展示

2. **技能卡面（觉醒卡面）**:
   - 独特技能的卡面图标
   - 取消之前使用支援卡作为技能卡面的设定

### 3. 名称映射系统

**新增文件**: `src/偶像大师闪耀色彩-gacha/data/name-mappings.ts`

**功能**:
- `CHARACTER_TO_ROMAN`: 角色名日文→罗马音映射（28个角色）
- `THEME_TO_ROMAN`: 主题日文→罗马音映射（200+主题）
- `cardNameToFileName()`: 将完整卡名转换为文件名

**示例**:
```typescript
cardNameToFileName('【絵空靴】杜野凛世', false)
// 返回: 'Ezoragutsu_Morino.Rinze'

cardNameToFileName('【絵空靴】杜野凛世', true)
// 返回: 'Ezoragutsu_Morino.Rinze+'
```

### 4. 卡片工具函数重构

**更新文件**: `src/偶像大师闪耀色彩-gacha/card-utils.ts`

**主要变更**:
- 新增 `buildCardImageUrlFromName()`: 基于完整卡名构建图片URL
- 新增 `extractCharacterName()`: 从完整卡名提取角色名
- 新增 `extractTheme()`: 从完整卡名提取主题
- 更新 `buildCardId()`: 使用完整卡名作为ID

**URL构建示例**:
```typescript
buildCardImageUrlFromName('【絵空靴】杜野凛世', false)
// 返回: 'https://github.com/2426269/shinycolors-assets/releases/download/角色卡面/Ezoragutsu_Morino.Rinze.png'
```

### 5. 抽卡动画系统

**新增组件**: `src/偶像大师闪耀色彩-gacha/components/GachaAnimation.vue`

**功能特性**:
1. **逐张翻牌动画**:
   - 一次只显示一张卡片，而不是一次性展示10张
   - 卡片从背面翻转到正面的动画效果
   - 翻转时长：500ms

2. **品级差异化动画**:
   - **R卡**: 蓝绿渐变背景，基础翻牌动画
   - **SR卡**: 紫色渐变背景，中等光效
   - **SSR卡**: 粉色渐变背景，持续光效脉动（`ssrGlow`动画）
   - **UR卡**: 金色渐变背景，强烈光效 + 文字发光（`urGlow` + `urTextGlow`动画）

3. **用户交互**:
   - 显示卡片稀有度和完整卡名
   - "下一张"按钮：跳过当前卡片，查看下一张
   - "查看结果"按钮：最后一张时显示，跳转到结果界面

4. **动画流程**:
   ```
   点击抽卡 → 卡背翻转(500ms) → 卡面展示 → 
   用户点击"下一张" → 下一张卡片 → ... → 
   所有卡片播放完毕 → 显示结果汇总界面
   ```

### 6. 抽卡核心逻辑更新

**更新文件**: `src/偶像大师闪耀色彩-gacha/gacha-core-real.ts`

**变更**:
- 导入 `buildCardImageUrlFromName`
- 在 `performSinglePullReal()` 中自动生成 `imageUrl`（未觉醒卡面）
- 确保所有抽卡结果都包含正确的卡面URL

### 7. UI组件本地化

**更新文件**: `src/偶像大师闪耀色彩-gacha/components/ResultDisplay.vue`

**变更**:
- "もう一度引く" → "再抽一次"
- "OK" → "确定"

### 8. 主应用逻辑集成

**更新文件**: `src/偶像大师闪耀色彩-gacha/app.vue`

**变更**:
1. 导入 `GachaAnimation` 组件
2. 新增状态：`isAnimating` 控制动画播放
3. 修改抽卡流程：
   ```typescript
   // 旧流程：抽卡 → 直接显示结果
   // 新流程：抽卡 → 播放动画 → 动画完成 → 显示结果
   ```
4. 新增 `handleAnimationComplete()`: 动画完成后显示结果并提示SSR+卡片
5. 更新UP角色卡面URL（使用未觉醒罗马音文件名）

### 9. 常量配置更新

**更新文件**: `src/偶像大师闪耀色彩-gacha/constants.ts`

**变更**:
```typescript
// 旧：export const CARD_IMAGE_BASE = `${RELEASE_BASE}/idol-cards`;
// 新：export const CARD_IMAGE_BASE = `${RELEASE_BASE}/角色卡面`;
```

## 📊 技术细节

### 卡面URL格式

**GitHub Release Tag**: `角色卡面`

**URL模板**:
```
https://github.com/2426269/shinycolors-assets/releases/download/角色卡面/[主题罗马音]_[角色罗马音][+].png
```

**示例**:
- 未觉醒：`https://github.com/2426269/shinycolors-assets/releases/download/角色卡面/Ezoragutsu_Morino.Rinze.png`
- 觉醒：`https://github.com/2426269/shinycolors-assets/releases/download/角色卡面/Ezoragutsu_Morino.Rinze+.png`

### 动画时序设计

```
阶段1: 卡背显示 (0-500ms)
  - 背景色根据品级变化
  - 脉动光效动画
  - 翻转动画开始

阶段2: 卡面显示 (500ms后)
  - 卡片正面翻转完成
  - 显示卡面图片（未觉醒）
  - 显示稀有度徽章和卡名
  - 品级光效持续播放（SSR/UR）
  - 显示交互按钮（下一张/查看结果）
```

### 品级视觉效果

| 品级 | 背景色   | 光效 | 特殊效果                |
| ---- | -------- | ---- | ----------------------- |
| R    | 蓝绿渐变 | 无   | -                       |
| SR   | 紫色渐变 | 中等 | -                       |
| SSR  | 粉色渐变 | 强烈 | 2s脉动循环              |
| UR   | 金色渐变 | 极强 | 1.5s脉动循环 + 文字发光 |

## 🎯 达成效果

1. ✅ **卡面文件可正常上传到GitHub Release**
   - 所有文件名为纯英文罗马音
   - 避免了Git对非ASCII字符的限制

2. ✅ **抽卡体验显著提升**
   - 从"瞬间展示结果"改为"逐张翻牌动画"
   - 不同品级有明显的视觉区分
   - 增强了抽卡的仪式感和期待感

3. ✅ **卡面使用规则清晰**
   - 未觉醒卡面用于所有日常展示
   - 觉醒卡面专用于技能图标
   - 统一了卡面显示逻辑

4. ✅ **代码结构更清晰**
   - 名称映射独立为单独模块
   - 卡面URL生成逻辑集中管理
   - 动画系统模块化实现

## 📁 文件清单

### 新增文件
- `src/偶像大师闪耀色彩-gacha/data/name-mappings.ts` - 名称映射
- `src/偶像大师闪耀色彩-gacha/components/GachaAnimation.vue` - 抽卡动画

### 修改文件
- `src/偶像大师闪耀色彩-gacha/constants.ts` - 更新卡面路径
- `src/偶像大师闪耀色彩-gacha/card-utils.ts` - 重构URL构建逻辑
- `src/偶像大师闪耀色彩-gacha/gacha-core-real.ts` - 集成卡面URL生成
- `src/偶像大师闪耀色彩-gacha/components/ResultDisplay.vue` - 本地化
- `src/偶像大师闪耀色彩-gacha/components/CardItem.vue` - 使用新URL
- `src/偶像大师闪耀色彩-gacha/app.vue` - 集成动画系统

### 临时文件（已清理）
- ~~`E:\偶像大师\移动卡面文件.ps1`~~
- ~~`E:\偶像大师\移动卡面文件.js`~~
- ~~`E:\偶像大师\重命名卡面为罗马音.js`~~

## 🚀 下一步工作

1. **上传卡面到GitHub Release**
   - Tag: `角色卡面`
   - 上传所有281个卡面文件（未觉醒 + 觉醒）

2. **测试抽卡动画**
   - 测试单抽流程
   - 测试十连流程
   - 验证各品级动画效果
   - 检查卡面加载速度

3. **继续Phase 1.6开发**
   - iframe通信系统
   - postMessage实现
   - chat:received拦截

## 💡 技术亮点

1. **自动化重命名系统**
   - 创建了智能映射表，覆盖200+主题和28个角色
   - 零错误处理281个文件的批量重命名

2. **CSS动画设计**
   - 使用@keyframes实现流畅的翻牌动画
   - 品级差异化的光效系统
   - 渐进式动画时序设计

3. **状态管理优化**
   - 动画状态与结果显示状态分离
   - 确保动画播放完成后才显示结果
   - 避免了状态冲突和UI闪烁

## 📝 备注

- 所有重命名脚本已按规范清理
- 构建测试通过，无linter错误
- 文件总大小：约XXX MB（待上传后统计）
- 支持所有现代浏览器的CSS动画特性


