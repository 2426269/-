# 明日计划 - 2025年11月2日

## 🎯 主要目标

**开始实现卡牌战斗系统核心代码**

---

## 📋 具体任务

### 阶段1: 核心类型定义（1-2小时）

**目标**: 建立类型系统基础

- [ ] **创建类型定义文件**
  - `src/偶像大师闪耀色彩-cardgame/types/battle-state.ts`
  - `src/偶像大师闪耀色彩-cardgame/types/skill-card.ts`
  - `src/偶像大师闪耀色彩-cardgame/types/buff.ts`
  - `src/偶像大师闪耀色彩-cardgame/types/effect.ts`

- [ ] **定义核心接口**
  ```typescript
  - BattleState
  - SkillCard
  - SkillCardEffect
  - Buff
  - BuffEffect
  - BattleConfig
  - BattleResult
  ```

**交付物**:
- ✅ 完整的TypeScript类型系统
- ✅ 所有接口和枚举定义

---

### 阶段2: 属性与资源管理（2-3小时）

**目标**: 实现属性系统和资源管理

- [ ] **AttributeManager类**
  - 属性增加（add）
  - 属性消耗（consume）
  - 属性查询（get）
  - 全力值转化逻辑

- [ ] **ResourceManager类**
  - 体力回复/消耗
  - 元气增加/消耗
  - Buff加成计算
  - 资源优先级处理

**交付物**:
- ✅ `src/偶像大师闪耀色彩-cardgame/core/attribute-manager.ts`
- ✅ `src/偶像大师闪耀色彩-cardgame/core/resource-manager.ts`
- ✅ 单元测试用例

---

### 阶段3: Buff系统（2-3小时）

**目标**: 实现完整的Buff管理系统

- [ ] **BuffManager类**
  - 添加Buff（addBuff）
  - 移除Buff（removeBuff）
  - 消耗Buff（consumeBuff）
  - 回合更新（updateBuffsOnTurnStart/End）
  - 触发效果（triggerBuffEffects）

- [ ] **Buff预设库**
  ```typescript
  - 感性系统：好調、集中、絶好調、状态绝佳
  - 理性系统：好印象、有干劲
  - 非凡系统：全力状态、温存状态、坚决状态
  - 通用：体力消耗减少、元气获取增加
  ```

**交付物**:
- ✅ `src/偶像大师闪耀色彩-cardgame/core/buff-manager.ts`
- ✅ `src/偶像大师闪耀色彩-cardgame/presets/buff-presets.ts`
- ✅ Buff效果测试

---

### 阶段4: 技能卡效果引擎（如有时间）

**目标**: 开始实现技能卡执行逻辑

- [ ] **SkillCardExecutor类基础结构**
  - execute方法框架
  - canUseCard检查
  - consumeCardCost资源消耗
  - executeEffect效果分发

- [ ] **实现基础效果类型**（5-10个）
  ```typescript
  - recover_stamina（回复体力）
  - gain_genki（获得元气）
  - add_concentration（增加专注）
  - add_motivation（增加干劲）
  - add_good_impression（增加好印象）
  - add_buff（添加Buff）
  - add_score（直接加分）
  - draw_cards（抽牌）
  - add_card_uses（增加使用数）
  ```

**交付物**:
- ✅ `src/偶像大师闪耀色彩-cardgame/core/skill-card-executor.ts`（部分完成）

---

## 🎯 次要目标（可选）

### 如果时间充裕

- [ ] **创建测试战斗**
  - 编写简单的测试脚本
  - 测试属性增减
  - 测试Buff添加/移除
  - 测试资源消耗

- [ ] **开始UI原型**
  - 创建`CardGame.vue`基础结构
  - 设计卡牌展示布局
  - 实现状态显示

---

## 📊 预期进度

### 乐观情况（8小时工作）
- ✅ 完成阶段1、2、3
- ✅ 完成阶段4的50%
- ✅ 开始测试

### 保守情况（6小时工作）
- ✅ 完成阶段1、2
- ✅ 完成阶段3的80%
- 🟡 阶段4待开始

---

## 🔧 技术要点

### 需要注意的关键点

1. **TypeScript类型安全**
   - 使用strict模式
   - 所有函数都要有明确的返回类型
   - 避免使用any

2. **状态不可变性**
   - 不直接修改state
   - 使用klona进行深拷贝（如需要）
   - 所有修改通过管理器类

3. **事件系统**
   - 使用EventBus触发UI更新
   - 每个重要操作都要emit事件
   - 事件命名规范：`属性_动作`（如`stamina_changed`）

4. **Buff触发时机**
   - 回合开始（turn_start）
   - 回合结束（turn_end）
   - 使用卡牌时（card_used）
   - 计算得分时（score_calculated）

5. **效果条件检查**
   - 所有效果都支持条件（condition）
   - 条件不满足时跳过效果
   - 提供友好的日志输出

---

## 📁 文件结构规划

```
src/偶像大师闪耀色彩-cardgame/
├── types/
│   ├── battle-state.ts          # 战斗状态类型
│   ├── skill-card.ts            # 技能卡类型
│   ├── buff.ts                  # Buff类型
│   └── effect.ts                # 效果类型
│
├── core/
│   ├── attribute-manager.ts     # 属性管理器
│   ├── resource-manager.ts      # 资源管理器
│   ├── buff-manager.ts          # Buff管理器
│   ├── skill-card-executor.ts   # 技能卡执行器
│   └── battle-controller.ts     # 战斗控制器（后续）
│
├── presets/
│   ├── buff-presets.ts          # Buff预设
│   └── skill-card-presets.ts    # 技能卡预设（后续）
│
├── utils/
│   ├── event-bus.ts             # 事件总线
│   └── logger.ts                # 日志工具
│
├── components/                  # Vue组件（后续）
│   ├── CardGame.vue
│   ├── SkillCard.vue
│   └── BuffBar.vue
│
└── index.ts                     # 导出入口
```

---

## ✅ 完成标准

### 阶段1完成标准
- [x] 所有类型定义编译通过
- [x] 没有TypeScript错误
- [x] 类型导出正确

### 阶段2完成标准
- [x] AttributeManager所有方法实现
- [x] ResourceManager所有方法实现
- [x] 能够正确增减属性和资源
- [x] 全力值转化逻辑正确

### 阶段3完成标准
- [x] BuffManager所有方法实现
- [x] 至少10个Buff预设完成
- [x] Buff触发时机正确
- [x] 回合更新逻辑正确

---

## 🎉 成功指标

**明日结束时应该能够**：
1. 创建一个空白战斗状态
2. 手动调用管理器增减属性
3. 手动添加/移除Buff
4. Buff在回合开始/结束时正确触发
5. 全力值满10时正确转化为全力状态

**代码质量**：
- 所有代码有完整的TypeScript类型
- 关键函数有注释说明
- 没有编译错误和警告

---

## 💡 技术储备

### 可能需要查阅的资源

1. **TypeScript**
   - 高级类型（联合类型、条件类型）
   - 泛型的使用
   - 类型守卫

2. **设计模式**
   - 策略模式（Buff效果）
   - 工厂模式（Buff创建）
   - 观察者模式（EventBus）

3. **Vue3**
   - Composition API
   - ref/reactive
   - watchEffect

---

## 📝 开发日志模板

```markdown
## 2025-11-02 开发日志

### 09:00 - 11:00
- [ ] 完成类型定义

### 11:00 - 13:00
- [ ] 实现AttributeManager
- [ ] 实现ResourceManager

### 14:00 - 17:00
- [ ] 实现BuffManager
- [ ] 创建Buff预设

### 17:00 - 18:00
- [ ] 测试与调试
- [ ] 文档更新

### 遇到的问题
- 

### 解决方案
- 

### 明日计划调整
- 
```

---

**计划状态**: ✅ 已制定  
**预计完成**: 60-80%的核心代码  
**下一步**: 开始编写类型定义文件
