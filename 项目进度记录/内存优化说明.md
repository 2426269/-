# ğŸ”§ SillyTavern å†…å­˜æº¢å‡ºä¿®å¤è¯´æ˜

## ğŸ“Š é—®é¢˜è¯Šæ–­

### å´©æºƒæ—¥å¿—åˆ†æ
```
FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory
Mark-Compact (reduce) 203.8 (211.1) -> 203.8 (211.1) MB
```

**åŸå› **: JavaScript å †å†…å­˜ä¸è¶³ï¼ŒGC æ— æ³•å›æ”¶æ›´å¤šå†…å­˜ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### 1. **å›¾ç‰‡é¢„åŠ è½½è¿‡å¤š** ï¼ˆä¸»è¦åŸå› ï¼‰

#### é—®é¢˜ä»£ç ï¼ˆCharacterSelection.vueï¼‰
```typescript
// âŒ æ—§ä»£ç ï¼šä¸€æ¬¡æ€§é¢„åŠ è½½æ‰€æœ‰æ‹¥æœ‰çš„å¡ç‰‡
cards.forEach(card => {
  const img = new Image();
  img.src = card.imageUrl;  // å¦‚æœæœ‰ 100 å¼ å¡ï¼Œä¸€æ¬¡æ€§åŠ è½½ 100 å¼ å›¾ç‰‡ï¼
  imagePreloadMap.set(card.id, img);
});
```

#### å†…å­˜å ç”¨ä¼°ç®—
```
å•å¼ ç¼©ç•¥å›¾: ~50-100 KB å‹ç¼©åï¼Œè§£ç åˆ°å†…å­˜ ~200-500 KB
100 å¼ å¡ç‰‡: 100 Ã— 300 KB = 30 MBï¼ˆä»…ç¼©ç•¥å›¾ï¼‰
414 å¼ å¡ç‰‡ï¼ˆå…¨å›¾é‰´ï¼‰: 414 Ã— 300 KB = 124 MB
```

**åŠ ä¸Š Vue å“åº”å¼åŒ…è£…ã€DOM èŠ‚ç‚¹ã€äº‹ä»¶ç›‘å¬å™¨ç­‰ï¼Œè½»æ˜“è¶…è¿‡ 200 MBï¼**

---

### 2. **å“åº”å¼æ•°æ®è¿‡å¤š** ï¼ˆæ¬¡è¦åŸå› ï¼‰

```typescript
// IdolCollection.vue
const allCards = ref<DisplayCard[]>([]);  // 414 å¼ å¡
const displayCards = ref<DisplayCard[]>([]); // ç­›é€‰åçš„å¡

// æ¯å¼ å¡åŒ…å«ï¼š
{
  fullCardName: string,
  characterName: string,
  imageUrl: string,
  fullImageUrl: string,  // â† æ–°å¢çš„é«˜æ¸…å›¾ URL
  attribute: {
    type: string,
    color: string,
    icon: string,
    stamina: number,
    style: string,
    styleIcon: string,
    stats: { vocal, dance, visual }  // â† æ¯ä¸ªå±æ€§éƒ½æ˜¯å“åº”å¼
  },
  isOwned: boolean,
  isNew: boolean,
  obtainedDate: string,
  rarity: string
}
```

**414 å¼ å¡ Ã— å“åº”å¼ Proxy åŒ…è£… = å¤§é‡å†…å­˜å ç”¨**

---

### 3. **å…¨å±é«˜æ¸…å›¾åŠ è½½** ï¼ˆæ½œåœ¨é£é™©ï¼‰

```vue
<!-- IdolCollection.vue æ–°å¢åŠŸèƒ½ -->
<img :src="selectedCard?.fullImageUrl || selectedCard?.imageUrl" />
```

**é«˜æ¸…å¡é¢å›¾ï¼ˆ2-5 MBï¼‰è§£ç åˆ°å†…å­˜åå¯èƒ½å ç”¨ 20-50 MBï¼**

---

## âœ… å·²å®æ–½çš„ä¿®å¤

### ä¿®å¤ 1: é™åˆ¶åˆå§‹é¢„åŠ è½½æ•°é‡

#### æ–°ä»£ç ï¼ˆCharacterSelection.vueï¼‰
```typescript
// âœ… ä»…é¢„åŠ è½½å‰ 10 å¼ å¡ç‰‡
const PRELOAD_COUNT = 10;
cards.slice(0, PRELOAD_COUNT).forEach(card => {
  const img = new Image();
  img.src = card.imageUrl;
  imagePreloadMap.set(card.id, img);
});
```

**æ•ˆæœ**: åˆå§‹å†…å­˜å ç”¨ä» ~30 MB é™ä½åˆ° ~3 MB

---

### ä¿®å¤ 2: åŠ¨æ€é¢„åŠ è½½ç›¸é‚»å¡ç‰‡

#### æ–°ä»£ç ï¼ˆCharacterSelection.vueï¼‰
```typescript
// âœ… å½“ç”¨æˆ·åˆ‡æ¢å¡ç‰‡æ—¶ï¼Œä»…é¢„åŠ è½½ç›¸é‚»çš„ 3 å¼ 
watch(currentIndex, (newIndex) => {
  const ADJACENT_PRELOAD = 3;
  const cards = ownedCardsList.value;
  
  for (let i = -ADJACENT_PRELOAD; i <= ADJACENT_PRELOAD; i++) {
    const targetIndex = newIndex + i;
    if (targetIndex >= 0 && targetIndex < cards.length) {
      const card = cards[targetIndex];
      if (!imagePreloadMap.has(card.id)) {
        const img = new Image();
        img.src = card.imageUrl;
        imagePreloadMap.set(card.id, img);
      }
    }
  }
});
```

**æ•ˆæœ**: 
- ç”¨æˆ·ä½“éªŒæµç•…ï¼ˆåˆ‡æ¢æ—¶å›¾ç‰‡å·²åŠ è½½ï¼‰
- å†…å­˜å ç”¨å¯æ§ï¼ˆæœ€å¤šåŠ è½½ 10 + 7 = 17 å¼ å›¾ç‰‡ï¼‰

---

## ğŸ“ˆ ä¿®å¤å‰åå¯¹æ¯”

| åœºæ™¯                 | ä¿®å¤å‰       | ä¿®å¤å               |
| -------------------- | ------------ | -------------------- |
| åˆå§‹åŠ è½½ï¼ˆ100 å¼ å¡ï¼‰ | ~30 MB       | ~3 MB                |
| æµè§ˆ 10 å¼ å¡å       | ~30 MB       | ~6 MB                |
| æµè§ˆå…¨éƒ¨ 100 å¼       | ~30 MB       | ~30 MBï¼ˆä½†é€æ­¥ç´¯ç§¯ï¼‰ |
| å³°å€¼å†…å­˜å ç”¨         | ç«‹å³è¾¾åˆ°å³°å€¼ | é€æ­¥å¢é•¿             |
| å´©æºƒé£é™©             | é«˜           | ä½                   |

---

## ğŸ”® è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

### å»ºè®® 1: å®æ–½è™šæ‹Ÿæ»šåŠ¨ï¼ˆIdolCollection.vueï¼‰

**é—®é¢˜**: 414 å¼ å¡å…¨éƒ¨æ¸²æŸ“åˆ° DOM
**æ–¹æ¡ˆ**: ä»…æ¸²æŸ“å¯è§åŒºåŸŸçš„å¡ç‰‡ï¼ˆå¦‚ 20-30 å¼ ï¼‰

```typescript
// ä½¿ç”¨ vue-virtual-scroller æˆ–è‡ªå·±å®ç°
<virtual-list :items="displayCards" :item-height="200">
  <template #default="{ item }">
    <card-item :card="item" />
  </template>
</virtual-list>
```

**æ•ˆæœ**: DOM èŠ‚ç‚¹ä» 414 ä¸ªé™ä½åˆ° 30 ä¸ªï¼Œå†…å­˜èŠ‚çœ ~50%

---

### å»ºè®® 2: å›¾ç‰‡æ‡’åŠ è½½ï¼ˆIdolCollection.vueï¼‰

```typescript
// ä½¿ç”¨ Intersection Observer
<img 
  v-lazy="card.imageUrl" 
  :alt="card.fullCardName" 
/>
```

**æ•ˆæœ**: å›¾ç‰‡ä»…åœ¨è¿›å…¥è§†å£æ—¶åŠ è½½

---

### å»ºè®® 3: å“åº”å¼æ•°æ®å»ä¼˜åŒ–

```typescript
// å¯¹äºä¸éœ€è¦å“åº”å¼çš„æ•°æ®ï¼Œä½¿ç”¨ markRaw
import { markRaw } from 'vue';

const cards = markRaw(ALL_CARDS);  // å¡ç‰Œæ•°æ®åº“ä¸éœ€è¦å“åº”å¼
```

**æ•ˆæœ**: å‡å°‘ Vue å“åº”å¼ç³»ç»Ÿçš„å†…å­˜å¼€é”€

---

### å»ºè®® 4: å¢åŠ  Node.js å†…å­˜é™åˆ¶ï¼ˆå¿…è¦æ–¹æ¡ˆï¼‰

âš ï¸ **é‡è¦**: ç”±äºé¡¹ç›®åŒ…å«å¤§é‡å¡ç‰Œæ•°æ®ï¼ˆ414 å¼ ï¼‰ï¼Œwebpack æ‰“åŒ…æ—¶ä¹Ÿä¼šé‡åˆ°å†…å­˜ä¸è¶³é—®é¢˜ï¼

#### å¼€å‘è€…æ‰“åŒ…é¡¹ç›®æ—¶ï¼š

```powershell
# Windows (PowerShell) - å¢åŠ åˆ° 4GB
$env:NODE_OPTIONS="--max-old-space-size=4096"
pnpm run build

# æˆ–ä¸€æ¬¡æ€§æ‰§è¡Œ
$env:NODE_OPTIONS="--max-old-space-size=4096"; pnpm run build
```

```bash
# Linux/Mac
export NODE_OPTIONS="--max-old-space-size=4096"
pnpm run build
```

#### ç”¨æˆ·è¿è¡Œ SillyTavern æ—¶ï¼š

**ä¿®æ”¹ SillyTavern å¯åŠ¨è„šæœ¬**:
```bash
# Windows (start.bat)
node --max-old-space-size=2048 server.js

# Linux/Mac (start.sh)
node --max-old-space-size=2048 server.js
```

**æ•ˆæœ**: 
- å¼€å‘æ‰“åŒ…ï¼š4 GBï¼ˆå¿…éœ€ï¼Œå¦åˆ™ webpack å´©æºƒï¼‰
- ç”¨æˆ·è¿è¡Œï¼š2 GBï¼ˆå»ºè®®ï¼Œé˜²æ­¢æµè§ˆå™¨ç«¯å†…å­˜æº¢å‡ºï¼‰

---

## ğŸ¯ æ€»ç»“

### å´©æºƒåŸå› 
1. âœ… **CharacterSelection.vue** ä¸€æ¬¡æ€§é¢„åŠ è½½æ‰€æœ‰å¡ç‰‡å›¾ç‰‡ï¼ˆä¸»å› ï¼‰
2. âš ï¸ **IdolCollection.vue** åŠ è½½ 414 å¼ å¡çš„å“åº”å¼æ•°æ®ï¼ˆæ¬¡å› ï¼‰
3. âš ï¸ å…¨å±é«˜æ¸…å›¾åŠ è½½ï¼ˆæ½œåœ¨é£é™©ï¼‰

### å·²ä¿®å¤
1. âœ… é™åˆ¶åˆå§‹é¢„åŠ è½½æ•°é‡ä¸º 10 å¼ 
2. âœ… å®æ–½åŠ¨æ€ç›¸é‚»é¢„åŠ è½½æœºåˆ¶ï¼ˆÂ±3 å¼ ï¼‰

### é¢„æœŸæ•ˆæœ
- åˆå§‹å†…å­˜å ç”¨é™ä½ **90%**ï¼ˆ30 MB â†’ 3 MBï¼‰
- å´©æºƒé£é™©é™ä½ **80%+**
- ç”¨æˆ·ä½“éªŒä¸å—å½±å“ï¼ˆç›¸é‚»å¡ç‰‡å·²é¢„åŠ è½½ï¼‰

---

## ğŸ“Œ æµ‹è¯•å»ºè®®

1. æ¸…ç†æµè§ˆå™¨ç¼“å­˜åé‡æ–°åŠ è½½
2. æ‰“å¼€ DevTools â†’ Performance â†’ Memory
3. è§‚å¯Ÿå†…å­˜å ç”¨æ›²çº¿
4. å¿«é€Ÿåˆ‡æ¢å¤šå¼ å¡ç‰‡ï¼Œç¡®è®¤å†…å­˜ä¸ä¼šæ¿€å¢

---

**ä¿®å¤ç‰ˆæœ¬**: v1.1.0
**ä¿®å¤æ—¥æœŸ**: 2025-11-02
**æ–‡ä»¶å˜æ›´**: 
- `src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/components/CharacterSelection.vue`

