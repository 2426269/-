# 压缩完成后的操作步骤

## 📊 当前状态

✅ 压缩脚本已启动，正在处理：
- **源目录**: `E:\偶像大师\闪耀色彩图片资源\角色卡面`
- **输出目录**: `E:\偶像大师\闪耀色彩图片资源-压缩版\角色卡面`
- **预计耗时**: 20-40分钟（取决于图片数量和CPU性能）

---

## 🔍 监控压缩进度

### 查看实时输出

打开PowerShell，输入：
```powershell
# 查看后台进程
Get-Process node

# 或者重新运行脚本查看实时输出（不推荐，会重复压缩）
cd E:\偶像大师
node compress-images.js
```

### 检查输出目录

```powershell
# 查看已压缩的文件数量
cd E:\偶像大师\闪耀色彩图片资源-压缩版\角色卡面
Get-ChildItem -Recurse *.png | Measure-Object

# 查看总大小
Get-ChildItem -Recurse | Measure-Object -Property Length -Sum
```

---

## ✅ 压缩完成后的操作

### 第1步：检查压缩结果

压缩完成后，脚本会输出类似信息：

```
📊 压缩完成统计

总文件数: 200
成功: 200 | 失败: 0

原始总大小: 1.2 GB
压缩后大小: 350 MB
WebP总大小: 180 MB

💾 节省空间: 850 MB (70.8%)
📦 WebP节省: 1.02 GB (85.0%)

⏱️  耗时: 32.5 秒
```

**检查要点**：
- ✅ 所有文件都成功压缩（失败: 0）
- ✅ WebP文件已生成
- ✅ 节省了70%+的空间

---

### 第2步：验证图片质量（重要！）

随机打开几张压缩后的图片，确认质量可接受：

```powershell
# 打开输出目录
explorer E:\偶像大师\闪耀色彩图片资源-压缩版\角色卡面
```

**对比检查**：
1. 打开原图和压缩后的图片
2. 确认画质没有明显下降
3. 如果质量不满意，修改 `compress-images.js` 的 `QUALITY` 配置（建议90）

---

### 第3步：压缩其他资源（可选）

如果需要压缩其他目录的图片：

```javascript
// 修改 compress-images.js 的配置
const CONFIG = {
  SOURCE_DIR: 'E:\\偶像大师\\闪耀色彩图片资源\\歌曲图片',  // 改为其他目录
  OUTPUT_DIR: 'E:\\偶像大师\\闪耀色彩图片资源-压缩版\\歌曲图片',
};
```

然后重新运行：
```bash
node compress-images.js
```

**建议压缩顺序**：
1. ✅ 角色卡面（当前正在压缩）
2. 歌曲图片/专辑封面
3. 背景图
4. 人物立绘
5. 游戏图标/组合图标

---

### 第4步：推送到GitHub主分支

#### 4.1 初始化Git仓库

```powershell
cd E:\偶像大师\闪耀色彩图片资源-压缩版

# 初始化
git init
git branch -M main
```

#### 4.2 配置Git LFS（如果有大文件）

```powershell
# 安装Git LFS（如果未安装）
git lfs install

# 跟踪大文件类型
git lfs track "*.png"
git lfs track "*.webp"
git lfs track "*.jpg"
git lfs track "*.mp3"

# 添加LFS配置
git add .gitattributes
git commit -m "配置Git LFS"
```

#### 4.3 添加并提交文件

```powershell
# 添加所有文件
git add .

# 提交
git commit -m "添加压缩后的角色卡面图片（WebP格式）"
```

#### 4.4 推送到GitHub

```powershell
# 连接远程仓库
git remote add origin https://github.com/2426269/shinycolors-assets.git

# 推送（如果是已存在的仓库）
git push -u origin main

# 或者推送到新分支
git push -u origin main --force  # ⚠️ 谨慎使用force
```

**⏱️ 预计推送时间**：
- 200MB: ~5-10分钟
- 500MB: ~15-30分钟
- 1GB: ~30-60分钟

---

### 第5步：修改代码使用jsDelivr CDN

打开 `src/偶像大师闪耀色彩/constants.ts`：

```typescript
// ==================== CDN配置 ====================

// 旧方案（GitHub Release，慢）
// const RELEASE_BASE = 'https://github.com/2426269/shinycolors-assets/releases/download';

// 新方案（jsDelivr CDN，快）
const CDN_BASE = 'https://cdn.jsdelivr.net/gh/2426269/shinycolors-assets@main';

// ==================== 资源路径 ====================

// 专辑封面
export const ALBUM_COVER_BASE = `${CDN_BASE}/歌曲图片`;

// 角色卡面（使用WebP格式）
export const CARD_IMAGE_BASE = `${CDN_BASE}/角色卡面`;

// 背景图
export const BACKGROUND_IMAGE_BASE = `${CDN_BASE}/背景图`;

// 游戏图标
export const GAME_ICONS_BASE = `${CDN_BASE}/游戏图标`;
```

#### 修改卡面加载逻辑使用WebP

打开 `src/偶像大师闪耀色彩-gacha/card-utils.ts`：

```typescript
/**
 * 构建卡片图片URL（优先使用WebP）
 */
export function buildCardImageUrlFromName(fullCardName: string, isAwakened: boolean): string {
  const fileName = cardNameToFileName(fullCardName);
  const awakenedSuffix = isAwakened ? '+' : '';
  
  // 使用WebP格式（更小，更快）
  return `${CARD_IMAGE_BASE}/${fileName}${awakenedSuffix}.webp`;
}
```

---

### 第6步：构建并测试

```powershell
cd E:\偶像大师\tavern_helper_template
npm run build
```

**测试要点**：
1. ✅ 图片能正常加载
2. ✅ 加载速度明显提升
3. ✅ 画质可接受

---

## 📊 性能对比（预期）

### 当前（GitHub Release）
- 单张图片: **3-10秒**
- 200张卡面: **10-30分钟**（不可用）

### 优化后（jsDelivr + WebP）
- 单张图片: **200-500ms**
- 200张卡面: **40-100秒**
- **提速: 10-20倍** 🚀

---

## ⚠️ 常见问题

### Q1: 压缩失败怎么办？

**检查错误信息**：
- 如果是内存不足：减少 `MAX_CONCURRENT`（改为2或3）
- 如果是某张图片损坏：手动删除该图片

**重新运行**：
```bash
node compress-images.js
```
脚本会跳过已压缩的文件。

---

### Q2: 如何确认WebP浏览器支持？

**现代浏览器全支持**（2023年数据）：
- ✅ Chrome 23+
- ✅ Firefox 65+
- ✅ Edge 18+
- ✅ Safari 14+
- ✅ Opera 12.1+

**兜底方案**（如果担心兼容性）：

```html
<picture>
  <source srcset="image.webp" type="image/webp">
  <img src="image.png" alt="fallback">
</picture>
```

---

### Q3: GitHub推送太慢怎么办？

**方案1：分批推送**
```bash
# 只推送角色卡面
cd E:\偶像大师\闪耀色彩图片资源-压缩版
git add 角色卡面/
git commit -m "添加角色卡面"
git push

# 稍后再推送其他文件夹
git add 歌曲图片/
git commit -m "添加歌曲图片"
git push
```

**方案2：使用Git LFS**
```bash
git lfs install
git lfs track "*.webp"
git add .gitattributes
git add .
git commit -m "使用Git LFS管理图片"
git push
```

---

### Q4: jsDelivr缓存如何更新？

**自动更新**：
- jsDelivr每12小时自动同步GitHub
- 或者等待24小时后自动刷新

**手动强制刷新**：
```typescript
// 使用特定commit强制更新
const CDN_BASE = 'https://cdn.jsdelivr.net/gh/2426269/shinycolors-assets@abc123';
//                                                                        ^^^^^^ commit哈希

// 获取最新commit
// git log -1 --format="%H"
```

**清除浏览器缓存**：
```
Ctrl + Shift + Delete（清除浏览器缓存）
或
Ctrl + F5（硬刷新）
```

---

## 🎉 完成后的效果

### 资源大小
- **原始**: ~1.2GB（角色卡面）
- **压缩后**: ~200-300MB（WebP）
- **节省**: **75-85%**

### 加载速度
- **原始**: 首次加载30秒+
- **优化后**: 首次加载3-5秒
- **提升**: **10-20倍**

### 用户体验
- ✅ 即时加载，无白屏
- ✅ 流畅的抽卡动画
- ✅ 快速切换卡面预览

---

## 📝 下一步计划

完成角色卡面压缩后，按优先级压缩其他资源：

1. **高优先级**（影响用户体验）
   - [ ] 角色卡面（当前正在进行）
   - [ ] 专辑封面/歌曲图片
   - [ ] UP角色全身立绘

2. **中优先级**（影响视觉效果）
   - [ ] 背景图
   - [ ] 人物立绘

3. **低优先级**（小文件，影响不大）
   - [ ] 游戏UI图标
   - [ ] 组合图标

**预计总时间**: 2-3小时（所有资源压缩完成）
**预计最终大小**: 500MB - 1GB（从原始7GB）



