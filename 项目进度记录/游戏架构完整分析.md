# 偶像大师闪耀色彩 - 游戏架构完整分析

**文档版本**: v1.0  
**日期**: 2025-10-30  
**基于**: 与Gemini的聊天记录分析

---

## 🎯 项目核心定位

### 项目本质
**不是**"SillyTavern角色卡"  
**而是**"独立的Web游戏应用 + SillyTavern作为AI后端"

### 核心理念
> "游戏的丢给HTML，剧情的丢给SillyTavern"

---

## 🏗️ 架构设计：双层分离

### 1. 前端层（Vue应用）- "游戏总监"

**运行环境**: `<iframe>` 沙盒内部  
**技术栈**: Vue.js + TypeScript + Pinia/Vuex

#### 职责范围
- ✅ **100%的游戏逻辑**
  - 打牌规则、数值计算
  - 回合制管理
  - 对战者模拟
  - 属性增减

- ✅ **100%的用户界面**
  - 所有UI组件
  - 动画效果
  - 用户交互

- ✅ **100%的短期数据管理**
  - localStorage存储
  - 羽石、粉丝、经验值
  - 卡牌库
  - 游戏过程数据

#### 数据存储（localStorage）
```typescript
{
  // 全局资源
  resources: {
    featherStones: number,  // 羽石
    fans: number,           // 粉丝
    producerLevel: number,  // 制作人等级
    producerExp: number     // 经验值
  },
  
  // 卡牌库
  card_inventory: {
    [cardId]: {
      id: string,
      level: number,
      stats: { vo, da, vi },
      unique_skill: null | SkillData
    }
  },
  
  // 拥有的偶像
  owned_idols: string[],
  
  // 抽卡数据
  gacha_data: {
    stardust: number,
    ownedCards: {},
    pity: {},
    history: []
  }
}
```

---

### 2. 后端层（SillyTavern）- "AI剧本家 + 数据服务器"

**运行环境**: `<iframe>` 外部，SillyTavern主环境  
**技术**: SillyTavern API + MVU变量系统

#### 职责范围
- ✅ **100%的AI文本生成**
  - 自由活动对话
  - 训练后小剧情
  - 比赛结局剧情
  - 好感度剧情
  - 角色技能描述

- ✅ **100%的叙事变量存储**（MVU）
  - 好感度
  - 当前地点
  - 当前时间
  - 角色状态
  - 剧情Flag

- ✅ **AI上下文管理**
  - 角色卡（Persona）
  - 聊天记忆
  - 专用Bot切换

#### MVU变量设计
```typescript
{{v::love_meter}}        // 好感度
{{v::current_location}}  // 当前地点
{{v::current_time}}      // 当前时间
{{v::story_flags}}       // 剧情标记
{{v::idol_status}}       // 偶像状态
```

---

### 3. 通信层（postMessage）

**协议**: window.postMessage() API

#### 通信方向

**Vue → SillyTavern（请求）**:
```typescript
window.parent.postMessage({
  type: 'GET_STORY',
  payload: {
    scenario: 'WING',
    event: 'TRAINING_SUCCESS',
    detail: { lesson: 'Vocal', result: 'great' }
  }
}, '*');
```

**SillyTavern → Vue（响应）**:
```typescript
iframeWindow.postMessage({
  type: 'STORY_GENERATED',
  payload: {
    story: "制作人，我好像抓到诀窍了！",
    rewards: { stamina: 10, love: 5 }
  }
}, vueAppOrigin);
```

#### 通信类型
| 消息类型          | 方向     | 用途             |
| ----------------- | -------- | ---------------- |
| `GET_STORY`       | Vue → ST | 请求剧情生成     |
| `STORY_GENERATED` | ST → Vue | 返回生成的剧情   |
| `GENERATE_SKILL`  | Vue → ST | 请求生成卡牌技能 |
| `SKILL_GENERATED` | ST → Vue | 返回技能JSON     |
| `TRAINING_RESULT` | Vue → ST | 上报训练结果     |
| `BATTLE_RESULT`   | Vue → ST | 上报比赛结果     |
| `SYNC_MVU`        | Vue → ST | 同步MVU变量      |

---

## 🎮 核心游戏循环

### 主循环（Meta Game）

```
用户启动游戏
    ↓
加载主页面（MainPage.vue）
    ↓
显示：羽石、粉丝、等级、偶像列表
    ↓
┌─────────────────────────────────┐
│ 用户选择：                       │
│ 1. 抽卡（Gacha） ✅ 已实现      │
│ 2. 培育（Produce）❌ 未实现     │
│ 3. 音乐（Music） ✅ 已实现      │
│ 4. 好感度剧情 ❌ 未实现          │
│ 5. 设置 ✅ 已实现                │
└─────────────────────────────────┘
```

### 培育循环（P-Produce）

```
选择剧本（WING / 感谢祭 / GRAD...）
    ↓
选择偶像
    ↓
初始化培育状态
{
  currentTurn: 1,
  maxTurns: 30,
  stats: { vo: 100, da: 100, vi: 100 },
  stamina: 100,
  loveMeter: 10
}
    ↓
┌─────────── 回合循环 ───────────┐
│                                 │
│  显示选项：                     │
│  - 训练（打牌）                 │
│  - 自由活动（地图）             │
│  - 休息                         │
│  - 比赛（特定回合）             │
│       ↓                         │
│  执行选择的行动                 │
│       ↓                         │
│  AI生成过场剧情                 │
│       ↓                         │
│  更新数值/好感度                │
│       ↓                         │
│  currentTurn++                  │
│       ↓                         │
│  ├─ 未到最终回合？ → 循环      │
│  └─ 到达最终回合？ ↓           │
│                                 │
└─────────────────────────────────┘
    ↓
最终比赛（打牌 + 对战者）
    ↓
计算总评价（S/A/B/C）
    ↓
发放奖励（羽石、粉丝、经验）
    ↓
AI生成结局剧情
    ↓
返回主页面
```

---

## 📦 系统模块设计

### 1. 主页面系统（Hub System）
**状态**: 🟡 部分实现

**组件结构**:
```
App.vue（根组件）
├─ MainPage.vue（主页面）✅
│  ├─ ProducerInfo（制作人信息）✅
│  ├─ ResourceDisplay（资源显示）✅
│  └─ FunctionButtons（功能按钮）✅
├─ SettingsPanel（设置面板）✅
└─ DevTools（开发工具）✅
```

**已实现**:
- ✅ 制作人信息展示
- ✅ 羽石/粉丝/等级显示
- ✅ 功能按钮（抽卡、音乐）
- ✅ 设置面板（全屏模式、开发工具）
- ✅ localStorage数据持久化

**未实现**:
- ❌ 偶像列表展示
- ❌ 好感度查看
- ❌ 培育入口
- ❌ 升级系统解锁提示

---

### 2. 抽卡系统（Gacha System）
**状态**: ✅ 完全实现

**组件结构**:
```
GachaApp.vue（抽卡主界面）✅
├─ ResourceBar（资源栏）✅
├─ PoolSidebar（卡池选择）✅
├─ GachaButton（抽卡按钮）✅
├─ RatesModal（概率弹窗）✅
└─ ResultDisplay（结果展示）✅
```

**核心功能**:
- ✅ 单抽/十连抽卡
- ✅ 概率系统（UR 0.5%, SSR 5%, SR 16%, R 78.5%）
- ✅ 保底机制（SSR 90抽，UR 200抽）
- ✅ 星尘转换系统
- ✅ 真实200张卡片数据
- ✅ 卡池详情展示
- ✅ UP卡标记

---

### 3. 音乐播放系统（Music System）
**状态**: ✅ 完全实现

**组件结构**:
```
MusicPlayer.ts（播放器核心）✅
└─ 嵌入在 App.vue 中
```

**核心功能**:
- ✅ 194首完整歌曲（个人曲/组合曲/全体曲）
- ✅ 播放控制（播放/暂停/上一首/下一首）
- ✅ 播放模式（单曲循环/顺序播放/随机播放）
- ✅ 专辑封面显示
- ✅ 歌词同步显示（原文+翻译）
- ✅ 音量控制
- ✅ 进度条拖动
- ✅ 跨标签页同步

---

### 4. P-Produce培育系统（Produce System）
**状态**: ❌ 未实现

**组件结构**（规划）:
```
ProduceHost.vue（培育总控）❌
├─ ScenarioLoader（剧本加载器）
├─ TurnManager（回合管理器）
├─ StatsDisplay（属性展示）
├─ ActionSelector（行动选择）
├─ CardGame（打牌界面）
├─ FreeActivityMap（自由活动地图）
├─ GalDialogue（剧情对话）
└─ ResultCalculator（结果计算）
```

**需要实现的功能**:
- ❌ 剧本系统（WING、感谢祭、GRAD...）
- ❌ 回合制框架
- ❌ 训练系统（连接打牌）
- ❌ 自由活动系统
- ❌ 比赛系统（对战者模拟）
- ❌ 评价系统（S/A/B/C）
- ❌ 奖励发放

---

### 5. 卡牌战斗系统（Card Game System）
**状态**: ❌ 未实现

**组件结构**（规划）:
```
CardGame.vue（战斗主界面）❌
├─ DeckManager（卡组管理）
├─ HandCards（手牌区）
├─ PlayArea（出牌区）
├─ EnemyArea（对手区）
├─ ScoreCalculator（分数计算）
└─ TurnIndicator（回合指示器）
```

**核心机制**:
- ❌ 卡牌系统（Cost、Type、Effect）
- ❌ 打牌逻辑（抽牌、出牌、回合）
- ❌ 分数计算（基于三维属性）
- ❌ AI对战者模拟
- ❌ 战斗结果判定（成功/大成功/失败）

**数值平衡系统**（重要）:
```typescript
// 平衡点（BP）系统
1 回合 = 10 BP

// 训练收益
大成功: 15 BP (Vocal +40, 体力-5)
成功: 10 BP (Vocal +25, 体力-5)
失败: 5 BP (Vocal +10, 体力-5)

// 自由活动收益
海滩: 10 BP (体力+20, 好感度+5)
图书馆: 10 BP (全三维+8, 好感度+2)
```

---

### 6. 自由活动地图系统（Free Activity System）
**状态**: ❌ 未实现

**组件结构**（规划）:
```
FreeActivityMap.vue（地图主界面）❌
├─ LocationSelector（地点选择器）
├─ LocationCard（地点卡片）
└─ RewardDisplay（奖励展示）
```

**模块化设计**:
```typescript
// 地点模块
interface Location {
  id: string;
  name: string;
  unlockCondition: { turn: number, scenario: string };
  rewards: {
    stamina?: number;
    love?: number;
    stats?: { vo?, da?, vi? };
  };
  aiPrompt: string;  // AI剧情生成提示
}

// 示例地点库
locations = [
  { id: 'beach', name: '海滩', rewards: { stamina: 20, love: 5 }, ... },
  { id: 'library', name: '图书馆', rewards: { vo: 8, da: 8, vi: 8, love: 2 }, ... },
  { id: 'cafe', name: '咖啡厅', rewards: { love: 10 }, ... },
  // ... 更多地点
];
```

**核心功能**:
- ❌ 地点卡片展示（每回合显示3个可用地点）
- ❌ 解锁条件判断（根据剧本和回合数）
- ❌ AI剧情生成（地点特定剧情）
- ❌ 奖励自动发放
- ❌ 模块化管理（新剧本只需调用不同地点组合）

---

### 7. 好感度剧情系统（Affection System）
**状态**: ❌ 未实现

**组件结构**（规划）:
```
AffectionSystem.vue（好感度主界面）❌
├─ IdolList（偶像列表）
├─ AffectionMeter（好感度进度条）
├─ StoryUnlockButton（剧情解锁按钮）
└─ GalDialogue（剧情播放）
```

**核心功能**:
- ❌ 好感度等级系统（1-10级）
- ❌ 好感度进度展示
- ❌ 剧情解锁条件判断
- ❌ AI生成专属剧情
- ❌ 好感度奖励（羽石、解锁内容）

**MVU集成**:
```typescript
// 每个偶像的好感度存储在MVU中
{{v::love_mano}}    // 樱木真乃好感度
{{v::love_hiori}}   // 风野灯织好感度
// ... 28个偶像
```

---

### 8. AI卡牌生成系统（Skill Generation System）
**状态**: ❌ 未实现

**组件结构**（规划）:
```
SkillGenerator（技能生成器）❌
├─ GenerationBot（专用Bot管理）
├─ PromptBuilder（提示词构建器）
├─ JSONParser（JSON解析器）
└─ LoadingOverlay（加载遮罩 + 四格漫画）
```

**核心流程**:
```
1. 玩家抽到新卡 → unique_skill: null（显示?按钮）
2. 点击? → 显示随机四格漫画加载页
3. Vue发送 GENERATE_SKILL 请求 → SillyTavern
4. ST切换到"Card Generation Bot"
5. ST发送魔法提示词给AI
6. AI返回JSON格式技能数据
7. ST拦截JSON，发回Vue
8. Vue保存到localStorage → unique_skill: {...}
9. 隐藏加载页，显示生成的技能
10. 永久生效（刷新后仍然存在）
```

**专用Bot设置**:
```
角色名: Card Generation Bot
角色设定（System Prompt）:
[System: 你的任务是设计卡牌技能。严格按照以下JSON格式回复。
{
  "name": "技能名称",
  "cost": <1-5>,
  "type": <"Attack"/"Support"/"Heal">,
  "description": "技能效果描述"
}

示例：
输入: Rarity: SSR, Theme: 夏日, Type: Vocal
输出: {
  "name": "夏日的回响",
  "cost": 3,
  "type": "Support",
  "description": "2回合内，所有Vocal卡牌分数提升50%。"
}]
```

**加载页四格漫画**:
- ❌ 四格漫画资源库（GitHub Release）
- ❌ 随机选择机制
- ❌ LoadingOverlay组件
- ❌ 加载动画 + 文本提示

---

### 9. 数据持久化系统（Persistence System）
**状态**: 🟡 部分实现

#### localStorage层（已实现）✅
```typescript
// 主页面资源
'shinycolors_resources'
'shinycolors_settings'

// 抽卡数据
'shinycolors_gacha_data'

// 音乐播放器
'shinycolors_music_state'
```

#### MVU层（未实现）❌
```typescript
// 叙事变量
{{v::love_mano}}           // 好感度
{{v::current_location}}    // 当前地点
{{v::story_flags}}         // 剧情标记
{{v::affection_stories}}   // 已解锁的好感度剧情
```

#### 需要实现的同步机制:
- ❌ Vue → MVU 同步函数
- ❌ MVU → Vue 读取函数
- ❌ 自动同步触发器
- ❌ 冲突解决策略

---

### 10. iframe通信系统（Communication System）
**状态**: ❌ 未实现

**核心文件**（规划）:
```
idolmaster_loader.html（加载器脚本）❌
├─ postMessage监听器
├─ chat:received拦截器
├─ Bot切换管理器
└─ 消息路由器
```

**需要实现的通信协议**:
```typescript
// Vue → SillyTavern
interface VueToSTMessage {
  type: 'GET_STORY' | 'GENERATE_SKILL' | 'SYNC_MVU' | ...;
  payload: any;
  requestId?: string;  // 用于匹配响应
}

// SillyTavern → Vue
interface STToVueMessage {
  type: 'STORY_GENERATED' | 'SKILL_GENERATED' | 'MVU_UPDATED' | ...;
  payload: any;
  requestId?: string;
}
```

**关键功能**:
- ❌ 双向通信建立
- ❌ 消息队列管理
- ❌ 请求-响应匹配
- ❌ AI响应拦截（chat:received）
- ❌ 静默操作（不在聊天气泡中显示）
- ❌ Bot切换机制
- ❌ 错误处理

---

## 🎯 Token优化策略

### 问题：传统SillyTavern聊天会爆Token
```
你: "我去训练Vocal了" (50 tokens)
AI: "你成功了，Vocal+10" (50 tokens)
... 30个回合后 ...
总计: 3000+ tokens → AI记忆崩溃
```

### 解决方案：Vue接管所有游戏逻辑

**游戏数据（0 Token）**:
```typescript
// 这些数据100%存在localStorage和Vue内存中
// AI永远看不到，Token占用 = 0
{
  currentTurn: 30,
  stats: { vo: 600, da: 500, vi: 400 },
  stamina: 50,
  inventory: [...]
}
```

**AI叙事（<2000 Tokens）**:
```typescript
// AI只在关键节点被调用
// 每次上下文 = 角色卡 + 单个情景请求
postMessage({
  type: 'GET_STORY',
  payload: { event: 'FINAL_RESULT', rank: 1 }
});

// AI Context: [角色卡] + [这一个请求]
// 结果：AI专注生成结局剧情，不需要记忆30回合的过程
```

---

## 🚀 性能优化策略

### 1. 按需加载（Lazy Loading）

**错误做法**（会卡死）:
```
启动时加载：
- 300张图片
- 100首歌曲
- 所有卡牌数据
→ 需要几分钟，浏览器卡死
```

**正确做法**（秒开）:
```
主页面启动:
- 只加载1张背景图
- 只加载1个角色立绘
- 只加载少量UI图标

点击"音乐":
- 才加载歌曲列表数据（不加载mp3文件）
- 点击播放时才流式传输该mp3

点击"抽卡":
- 才加载抽卡界面资源
```

### 2. 资源管理

**GitHub Release作为CDN**:
```
优点:
✅ 零成本
✅ 永久存储
✅ 可靠性高

缺点:
⚠️ 不是专业CDN，速度一般
⚠️ 需要按需加载设计
```

### 3. 代码分割

**app.js优化**:
```
❌ 错误：把所有卡牌描述硬编码在.ts文件中
→ app.js变成5MB

✅ 正确：卡牌数据存为card_database.json
→ 需要时fetch()异步加载
→ app.js保持小巧（<500KB）
```

---

## 📊 开发优先级

### Phase 1: 基础架构（当前阶段）
- ✅ 主页面UI
- ✅ 抽卡系统
- ✅ 音乐系统
- ✅ localStorage持久化
- ❌ **iframe通信系统**（下一步关键）

### Phase 2: 核心玩法
- ❌ **卡牌战斗系统**（核心机制）
- ❌ P-Produce培育框架
- ❌ 回合制系统
- ❌ 数值平衡系统

### Phase 3: AI叙事集成
- ❌ postMessage通信完整实现
- ❌ AI剧情生成（训练后/自由活动/结局）
- ❌ MVU变量同步
- ❌ 专用Bot（卡牌生成）

### Phase 4: 内容填充
- ❌ 自由活动地图（模块化地点库）
- ❌ 多个剧本（WING、感谢祭、GRAD...）
- ❌ 好感度剧情系统
- ❌ AI卡牌生成 + 四格漫画加载页

### Phase 5: 优化与完善
- ❌ 性能优化（按需加载）
- ❌ UI/UX打磨
- ❌ 错误处理
- ❌ 用户引导

---

## 🛠️ 技术债务

### 当前问题
1. **没有iframe通信层** - 无法与SillyTavern交互
2. **没有MVU集成** - 叙事变量无法永久保存
3. **缺少核心玩法** - 打牌系统和培育系统未实现

### 需要重构的地方
1. **主页面** - 需要添加偶像列表、好感度入口
2. **开发工具** - 当前依赖AI生成的卡牌数据结构（需要真实卡牌系统后重构）

---

## 💡 关键设计决策记录

### 1. 为什么用localStorage而不是全部用MVU？
**决策**: 90%的游戏数据用localStorage，只有AI相关的叙事变量用MVU

**理由**:
- localStorage读写极快，适合频繁更新的游戏数据
- AI不需要知道羽石数量或卡牌列表
- MVU只存AI生成剧情时需要的上下文
- 避免Token浪费

### 2. 为什么打牌时不实时调用AI？
**决策**: 打牌过程纯代码，结束后才调用AI生成剧情

**理由**:
- 打牌是高频操作，AI响应慢会卡顿
- 纯代码速度飞快，体验流畅
- 结果驱动互动（只在关键节点调用AI）
- Token优化（不需要AI记忆打牌过程）

### 3. 为什么需要专用的"Card Generation Bot"？
**决策**: 创建一个无聊天记录的专用Bot来生成卡牌

**理由**:
- 上下文隔离（不污染主聊天的角色扮演）
- 专业化提示词（只关注JSON生成）
- 提高成功率（AI不会混淆任务）

---

## 📚 参考文档

### 已创建的文档
1. `音乐系统技术文档.md` - 音乐播放器完整文档
2. `抽卡系统开发方案.md` - 抽卡系统设计文档
3. `AI交互增强系统_完整企划.md` - MVU集成和高级通信方案
4. `MVU变量集成_技术实施指南.md` - MVU技术细节

### 需要创建的文档
- [ ] 卡牌战斗系统设计文档
- [ ] P-Produce培育系统设计文档
- [ ] iframe通信协议规范
- [ ] 数值平衡系统设计文档

---

**当前状态**: 🟡 基础架构已完成60%，核心玩法待开发  
**下一步**: 实现iframe通信系统，建立Vue与SillyTavern的连接


