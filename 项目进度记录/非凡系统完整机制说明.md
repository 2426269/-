# 非凡系统（アノマリー）完整机制说明

## 📊 系统概览

非凡系统是卡牌战斗中的核心机制之一，涉及**全力值**、**热意值**和**四态切换**。

---

## 🎯 核心数值

### 1. 全力值（AllPower）
- **范围**: 0-10
- **作用**: 达到10自动转化为"全力状态"
- **获取方式**:
  - ✅ 使用技能卡效果（`add_all_power`）
  - ✅ 坚决状态下使用卡牌（每张+1或+2）
  - ✅ 特定Buff触发

```typescript
// AttributeManager.ts - 自动转化机制
private onAttributeChanged(attributeName: string, delta: number): void {
  // 特殊处理：全力值满10
  if (attributeName === 'allPower') {
    const allPower = this.get('allPower');
    if (allPower >= 10) {
      this.triggerAllPowerTransform(); // 自动转化
    }
  }
}

private triggerAllPowerTransform(): void {
  // 1. 消耗10全力值
  this.state.attributes.allPower = 0;

  // 2. 切换到全力状态（一阶段）
  this.state.attributes.anomalyState = 'allout';
  this.state.attributes.stateLevel = 1;

  // 3. 触发事件（AnomalySystem会自动添加全力状态Buff）
  EventBus.emit(GameEvents.ALL_POWER_FULL, {
    planType: this.state.planType,
  });
}
```

### 2. 热意值（Heat）
- **范围**: 0-∞
- **作用**: 达到5自动升级状态（一阶段→二阶段）
- **获取方式**:
  - ✅ 温存状态下每回合结束（一阶段+2，二阶段+3）
  - ✅ 使用技能卡效果（`add_heat`）
  - ✅ 特定Buff触发

```typescript
// AnomalySystem.ts - 自动升级机制
onTurnEnd(): void {
  const currentState = this.state.attributes.anomalyState;
  const heat = this.attributeManager.get('heat');
  const level = this.state.attributes.stateLevel;

  if (heat >= 5 && level === 1 && currentState) {
    // 自动升级到2阶段
    this.upgradeState();
    // 消耗热意值
    this.state.attributes.heat = 0;
  }
}
```

### 3. 温存值 ❌
> **注意**: 游戏中**没有"温存值"**这个数值！
> 温存是一个**状态**（conserve），不是数值属性。

---

## 🔄 四态转化系统

### 状态列表

| 状态名称         | 英文     | 一阶段效果       | 二阶段效果       | 持续回合 |
| ---------------- | -------- | ---------------- | ---------------- | -------- |
| **全力状态**     | allout   | 得分 ×3 (+200%)  | 得分 ×4 (+300%)  | 3回合    |
| **温存状态**     | conserve | 回合结束+2热意值 | 回合结束+3热意值 | 3回合    |
| **坚决状态**     | resolute | 使用卡牌+1全力值 | 使用卡牌+2全力值 | 3回合    |
| **のんびり状态** | relaxed  | 待扩展           | 待扩展           | 3回合    |

---

## 🌊 状态流转图

```
┌─────────────────────────────────────────────────────────────┐
│                     初始状态（无状态）                         │
│                   allPower: 0, heat: 0                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ 通过技能卡或坚决状态累积全力值
                       ↓
            ┌──────────────────────┐
            │  allPower ≥ 10 ?     │
            └──────┬───────────────┘
                   │ Yes
                   ↓
        ┌─────────────────────────┐
        │    消耗10全力值          │
        │    进入全力状态（一阶段）  │
        │    添加全力状态Buff       │
        │    得分×3，持续3回合      │
        └─────────┬───────────────┘
                  │
                  │ 3回合后Buff自然消失
                  ↓
        ┌─────────────────────────┐
        │    状态结束              │
        │    回到无状态            │
        └─────────────────────────┘


或者通过技能卡主动切换：

        ┌─────────────────────────┐
        │  技能卡效果:             │
        │  switch_anomaly_state    │
        └──────┬──────────────────┘
               │
               ↓
    ┌──────────────────────────────────┐
    │ 切换到指定状态（温存/坚决/のんびり）│
    │ 退出旧状态Buff，进入新状态Buff      │
    └──────────────────────────────────┘
```

---

## 📈 状态升级机制

### 一阶段 → 二阶段

```
温存状态（一阶段）
    ↓ 每回合结束+2热意值
heat = 5 ?
    ↓ Yes
自动升级到二阶段
消耗5热意值
效果增强：每回合结束+3热意值
```

**实现代码**:
```typescript
// AnomalySystem.ts
upgradeState(): boolean {
  const currentState = this.state.attributes.anomalyState;
  const currentLevel = this.state.attributes.stateLevel;

  if (!currentState || currentLevel === 2) {
    return false; // 没有状态或已经是2阶段
  }

  // 升级到2阶段
  this.switchState(currentState, 2);
  return true;
}
```

---

## 🎮 完整工作流程示例

### 示例1：全力值累积 → 全力状态

```typescript
// 回合1：使用技能卡
使用卡牌: "全力集中" → 效果: add_all_power(3)
全力值: 0 → 3

// 回合2：使用技能卡
使用卡牌: "冲刺加速" → 效果: add_all_power(4)
全力值: 3 → 7

// 回合3：使用技能卡
使用卡牌: "最后冲刺" → 效果: add_all_power(3)
全力值: 7 → 10 ✅

// ⚡ 自动触发转化
AttributeManager.triggerAllPowerTransform()
  → 消耗10全力值
  → 切换到全力状态（一阶段）
  → EventBus.emit(ALL_POWER_FULL)
  → AnomalySystem监听事件
  → BuffManager.addBuff(全力状态Buff)

// 回合4-6：全力状态生效
得分计算时自动×3
持续3回合后Buff消失
```

### 示例2：温存状态 → 热意值累积 → 升级

```typescript
// 回合1：使用技能卡切换状态
使用卡牌: "温存节奏" → 效果: switch_anomaly_state('conserve', 1)
  → AnomalySystem.switchState('conserve', 1)
  → 添加温存状态Buff（一阶段）

// 回合1结束：
温存状态Buff触发 turn_end 效果
  → heat += 2
  → heat: 0 → 2

// 回合2结束：
heat += 2 → heat: 2 → 4

// 回合3结束：
heat += 2 → heat: 4 → 6 ✅ (≥5)

// ⚡ 自动升级
AnomalySystem.onTurnEnd()
  → 检测到 heat ≥ 5 且 level === 1
  → upgradeState()
  → 切换到温存状态（二阶段）
  → 消耗热意值: heat = 0

// 回合4-6：温存状态（二阶段）生效
每回合结束 +3 热意值（而不是+2）
```

### 示例3：坚决状态 → 快速累积全力值

```typescript
// 回合1：切换到坚决状态
使用卡牌: "坚定意志" → 效果: switch_anomaly_state('resolute', 1)
  → 添加坚决状态Buff（一阶段）

// 回合2：使用多张卡牌
使用卡牌1: "基础训练"
  → 坚决状态Buff触发 card_used 效果
  → allPower += 1 (一阶段)

使用卡牌2: "专注练习"
  → allPower += 1

使用卡牌3: "强化训练"
  → allPower += 1

全力值: 0 → 3

// 回合3：继续使用卡牌
使用卡牌4: "技巧磨练"
  → allPower += 1 → 4

// ... 持续累积

// 回合5：
使用卡牌: "全力爆发"
  → allPower += 6 → 10 ✅

// ⚡ 自动转化为全力状态
（同示例1）
```

---

## 🔧 技术实现层次

### 1. 数据层（BattleState）
```typescript
interface BattleAttributes {
  allPower: number;        // 全力值（0-10）
  heat: number;            // 热意值（0-∞）
  anomalyState: AnomalyState; // 当前状态
  stateLevel: 1 | 2;       // 状态阶段
  pointerLocked: boolean;   // 指针锁定
  // ...
}
```

### 2. 管理层（AttributeManager）
- ✅ 管理全力值、热意值的增减
- ✅ 自动检测全力值≥10，触发转化
- ✅ 切换非凡状态
- ✅ 发送事件通知

```typescript
// 核心方法
add(attributeName, value)           // 增加属性
consume(attributeName, value)       // 消耗属性
switchAnomalyState(newState, level) // 切换状态
lockPointer() / unlockPointer()     // 锁定/解锁指针
```

### 3. 系统层（AnomalySystem）
- ✅ 监听全力值满事件，添加全力状态Buff
- ✅ 进入/退出状态时的Buff管理
- ✅ 回合结束检查热意值，自动升级状态
- ✅ 提供状态查询接口

```typescript
// 核心方法
switchState(newState, level)  // 切换状态
addAllPower(amount)           // 增加全力值
addHeat(amount)               // 增加热意值
upgradeState()                // 升级状态
onTurnEnd()                   // 回合结束处理
```

### 4. Buff层（BuffPresets）
- ✅ 全力状态Buff：得分×3或×4
- ✅ 温存状态Buff：回合结束+2或+3热意值
- ✅ 坚决状态Buff：使用卡牌+1或+2全力值

```typescript
// Buff触发时机
全力状态: score_calculated  // 计分时触发
温存状态: turn_end          // 回合结束时触发
坚决状态: card_used         // 使用卡牌时触发
```

---

## 🎯 关键设计要点

### 1. 自动化机制
- ✅ **全力值满10** → 自动转化为全力状态（无需手动触发）
- ✅ **热意值达5** → 自动升级状态阶段（无需手动触发）
- ✅ **Buff自然过期** → 3回合后自动结束状态

### 2. 事件驱动
```typescript
EventBus.on(GameEvents.ALL_POWER_FULL, () => {
  // AnomalySystem监听，自动添加全力状态Buff
});

EventBus.on(GameEvents.ANOMALY_STATE_CHANGED, ({ oldState, newState }) => {
  // UI自动更新显示
});
```

### 3. 解耦设计
- `AttributeManager` 只负责数值管理和状态切换
- `AnomalySystem` 负责状态流转和Buff管理
- `BuffManager` 负责Buff效果触发
- 各层通过 `EventBus` 通信

### 4. 状态互斥
```typescript
// 同一时间只能有一个非凡状态
switchState(newState, level) {
  const oldState = this.state.attributes.anomalyState;
  
  // 退出旧状态（移除旧Buff）
  if (oldState) {
    this.exitState(oldState);
  }
  
  // 进入新状态（添加新Buff）
  this.enterState(newState, level);
}
```

---

## 📝 使用示例代码

### 在战斗中使用非凡系统

```typescript
import { BattleController } from './core/battle-controller';
import { AnomalySystem } from './systems/anomaly-system';

// 1. 创建战斗控制器（planType选择anomaly）
const controller = new BattleController({
  mode: 'training',
  planType: 'anomaly', // 非凡计划
  stats: { vocal: 100, dance: 100, visual: 100 },
  skillDeck: createAnomalyDeck(), // 使用非凡系统卡组
});

// 2. 获取非凡系统实例
const anomalySystem = new AnomalySystem(controller.getState());

// 3. 查询当前状态
const stateInfo = anomalySystem.getCurrentStateInfo();
console.log(`当前状态: ${stateInfo.state}`);
console.log(`阶段: ${stateInfo.level}`);
console.log(`全力值: ${stateInfo.allPower}/10`);
console.log(`热意值: ${stateInfo.heat}`);

// 4. 手动操作（通常通过技能卡自动触发）
anomalySystem.addAllPower(3);  // 增加3全力值
anomalySystem.addHeat(2);      // 增加2热意值
anomalySystem.switchState('conserve', 1); // 切换到温存状态

// 5. 监听事件
EventBus.on(GameEvents.ANOMALY_STATE_CHANGED, ({ oldState, newState, level }) => {
  console.log(`状态变化: ${oldState} → ${newState} (${level}阶段)`);
});

EventBus.on(GameEvents.ALL_POWER_FULL, () => {
  console.log('全力值满！自动进入全力状态！');
});
```

---

## ⚠️ 常见误区

### ❌ 误区1：温存值
**错误**: 认为有"温存值"这个数值  
**正确**: 温存是一个**状态**，通过热意值来升级

### ❌ 误区2：手动触发转化
**错误**: 需要手动调用函数来转化全力状态  
**正确**: 全力值达到10时**自动转化**

### ❌ 误区3：状态可叠加
**错误**: 可以同时拥有多个非凡状态  
**正确**: 同一时间只能有**一个**非凡状态

### ❌ 误区4：状态永久
**错误**: 状态一直持续  
**正确**: 所有状态默认持续**3回合**

---

## 📊 完整数据流图

```
┌─────────────────────────────────────────────────────────┐
│                   玩家使用技能卡                         │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ↓
        ┌─────────────────────┐
        │ SkillCardExecutor   │
        │ 解析效果:            │
        │ - add_all_power(3)  │
        │ - add_heat(2)       │
        │ - switch_state      │
        └──────┬──────────────┘
               │
               ↓
        ┌─────────────────────┐
        │ AttributeManager    │
        │ 更新数值:            │
        │ - allPower += 3     │
        │ - heat += 2         │
        └──────┬──────────────┘
               │
               ↓
        ┌─────────────────────┐
        │ 自动检测:            │
        │ allPower ≥ 10 ?     │
        └──────┬──────────────┘
               │ Yes
               ↓
        ┌─────────────────────┐
        │ 触发事件:            │
        │ ALL_POWER_FULL      │
        └──────┬──────────────┘
               │
               ↓
        ┌─────────────────────┐
        │ AnomalySystem       │
        │ 监听事件:            │
        │ - 切换状态          │
        │ - 添加Buff          │
        └──────┬──────────────┘
               │
               ↓
        ┌─────────────────────┐
        │ BuffManager         │
        │ 添加全力状态Buff     │
        │ - 得分×3            │
        │ - 持续3回合         │
        └──────┬──────────────┘
               │
               ↓
        ┌─────────────────────┐
        │ EventBus            │
        │ 通知UI更新          │
        └──────┬──────────────┘
               │
               ↓
        ┌─────────────────────┐
        │ Vue组件             │
        │ 显示状态图标        │
        │ 显示全力值/热意值   │
        └─────────────────────┘
```

---

## 🎓 总结

### 核心机制
1. **全力值（0-10）** → 达到10自动转化为全力状态
2. **热意值（0-∞）** → 达到5自动升级状态阶段
3. **四态切换** → 全力/温存/坚决/のんびり，同时只能有一个
4. **自动化** → 转化和升级全自动，无需手动触发

### 实现特点
- ✅ **事件驱动**: 通过EventBus解耦各模块
- ✅ **分层清晰**: 数据层→管理层→系统层→Buff层
- ✅ **类型安全**: 100% TypeScript覆盖
- ✅ **易于扩展**: 新增状态只需添加Buff预设

### 未来扩展
- 🔜 のんびり状态的具体效果
- 🔜 更多状态切换技能卡
- 🔜 状态连锁效果
- 🔜 状态特殊动画

---

**文档创建时间**: 2025年11月1日  
**版本**: v1.0  
**状态**: ✅ 完整实现









