# å¶åƒå¤§å¸ˆé—ªè€€è‰²å½© - é¡¹ç›®å¼€å‘å¤§çº²ï¼ˆé©æ–°ç‰ˆï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 ğŸ†• **é‡å¤§æ¶æ„é©æ–°**  
**æ—¥æœŸ**: 2025-11-03  
**é¢„è®¡å®Œæˆæ—¶é—´**: 3-4ä¸ªæœˆï¼ˆç®€åŒ–åå¤§å¹…ç¼©çŸ­ï¼‰  
**æ¶æ„æ ¸å¿ƒ**: **æ·±åº¦é›†æˆé…’é¦†åŠ©æ‰‹ç”Ÿæ€ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰åŠŸèƒ½**

---

## ğŸ¯ æ¶æ„é©æ–°æ ¸å¿ƒæ€æƒ³

### âŒ æ—§æ¶æ„é—®é¢˜
- è‡ªå·±å®ç° iframe é€šä¿¡ â†’ **é‡å¤é€ è½®å­**
- è‡ªå·±å®ç°äº‹ä»¶ç›‘å¬ â†’ **é…’é¦†åŠ©æ‰‹å·²æœ‰**
- è‡ªå·±ç®¡ç†æ‰€æœ‰æ•°æ® â†’ **é…’é¦†å˜é‡ç³»ç»Ÿè¢«æµªè´¹**
- æç¤ºè¯å…¨åœ¨ä»£ç é‡Œ â†’ **éš¾ä»¥è°ƒæ•´ã€ç‰ˆæœ¬æ§åˆ¶å›°éš¾**
- å‰ç«¯ç•Œé¢å®Œå…¨ç‹¬ç«‹ â†’ **ä¸é…’é¦†å‰²è£‚ï¼Œæ— æ³•åˆ©ç”¨ç°æœ‰UI**

### âœ… æ–°æ¶æ„ä¼˜åŠ¿
- **é…’é¦†åŠ©æ‰‹äº‹ä»¶ç³»ç»Ÿ** â†’ ç›‘å¬æ¶ˆæ¯ã€èŠå¤©ã€è§’è‰²åˆ‡æ¢
- **é…’é¦†ä¸–ç•Œä¹¦** â†’ å­˜å‚¨äººè®¾ã€æ‰®æ¼”è¦æ±‚ã€å‰§æƒ…è¦æ±‚ã€æ€ç»´é“¾
- **é…’é¦†å˜é‡** â†’ å­˜å‚¨ç¾½çŸ³ã€ç²‰ä¸ã€å¥½æ„Ÿåº¦ã€åŸ¹è‚²çŠ¶æ€
- **é…’é¦†è„šæœ¬** â†’ SpineåŠ¨ç”»æ§åˆ¶ã€èƒŒæ™¯åˆ‡æ¢ã€è‡ªåŠ¨åŒ–æµç¨‹
- **STScript** â†’ å¤æ‚é€»è¾‘ã€æ¡ä»¶åˆ¤æ–­ã€å¥–åŠ±è§£æ
- **jQueryæ³¨å…¥** â†’ çŠ¶æ€æ ã€å¿«æ·æŒ‰é’®æ³¨å…¥åˆ°é…’é¦†ç•Œé¢
- **æ··åˆæ¨¡å¼** â†’ é‡UIéƒ¨åˆ†ï¼ˆæŠ½å¡ã€æ‰“ç‰Œï¼‰ç”¨iframeï¼Œè½»é‡éƒ¨åˆ†ï¼ˆçŠ¶æ€ã€æŒ‰é’®ï¼‰æ³¨å…¥é…’é¦†

---

## ğŸ“‹ æ–°æ¶æ„ç›®å½•

1. [Phase 1: åŸºç¡€è®¾æ–½ï¼ˆé…’é¦†é›†æˆï¼‰](#phase-1-åŸºç¡€è®¾æ–½é…’é¦†é›†æˆ)
2. [Phase 2: æ ¸å¿ƒç©æ³•ï¼ˆæ··åˆæ¨¡å¼ï¼‰](#phase-2-æ ¸å¿ƒç©æ³•æ··åˆæ¨¡å¼)
3. [Phase 3: AIå™äº‹ï¼ˆä¸–ç•Œä¹¦é©±åŠ¨ï¼‰](#phase-3-aiå™äº‹ä¸–ç•Œä¹¦é©±åŠ¨)
4. [Phase 4: å†…å®¹å¡«å……ï¼ˆè„šæœ¬è‡ªåŠ¨åŒ–ï¼‰](#phase-4-å†…å®¹å¡«å……è„šæœ¬è‡ªåŠ¨åŒ–)
5. [Phase 5: ä¼˜åŒ–ä¸å®Œå–„](#phase-5-ä¼˜åŒ–ä¸å®Œå–„)

---

## Phase 1: åŸºç¡€è®¾æ–½ï¼ˆé…’é¦†é›†æˆï¼‰

**ç›®æ ‡**: å»ºç«‹ä¸é…’é¦†åŠ©æ‰‹çš„æ·±åº¦é›†æˆ  
**é¢„è®¡æ—¶é—´**: 2å‘¨ â¬ï¼ˆä»4å‘¨ç¼©çŸ­ï¼‰  
**æ ¸å¿ƒ**: ä¸å†é€ è½®å­ï¼Œå……åˆ†åˆ©ç”¨ç°æœ‰åŠŸèƒ½

### 1.1 æ•°æ®å­˜å‚¨æ–¹æ¡ˆé‡æ„ âœ¨

#### é…’é¦†å˜é‡åˆ†é…

```typescript
// ä½¿ç”¨é…’é¦†å˜é‡ç³»ç»Ÿæ›¿ä»£ IndexedDB
{
  // å…¨å±€å˜é‡ï¼ˆæ¸¸æˆèµ„æºï¼‰
  "å¶åƒå¤§å¸ˆ_ç¾½çŸ³": 3000,
  "å¶åƒå¤§å¸ˆ_ç²‰ä¸": 0,
  "å¶åƒå¤§å¸ˆ_åˆ¶ä½œäººç­‰çº§": 1,
  "å¶åƒå¤§å¸ˆ_åˆ¶ä½œäººç»éªŒ": 0,
  
  // è§’è‰²å¡å˜é‡ï¼ˆæ¯ä¸ªå¶åƒçš„å¥½æ„Ÿåº¦ï¼‰
  "å¥½æ„Ÿåº¦_æ¨±æœ¨çœŸä¹ƒ": 0,
  "å¥½æ„Ÿåº¦_é£é‡ç¯ç»‡": 0,
  // ... 28ä¸ªå¶åƒ
  
  // èŠå¤©å˜é‡ï¼ˆå½“å‰åŸ¹è‚²ä¼šè¯ï¼‰
  "åŸ¹è‚²_å½“å‰å›åˆ": 1,
  "åŸ¹è‚²_æœ€å¤§å›åˆ": 18,
  "åŸ¹è‚²_ä½“åŠ›": 60,
  "åŸ¹è‚²_æœ€å¤§ä½“åŠ›": 60,
  "åŸ¹è‚²_VO": 100,
  "åŸ¹è‚²_DA": 100,
  "åŸ¹è‚²_VI": 100,
  "åŸ¹è‚²_å…ƒæ°”": 0,
  "åŸ¹è‚²_å‰§æœ¬ID": "wing",
  "åŸ¹è‚²_å¶åƒID": "mano",
  
  // è„šæœ¬å˜é‡ï¼ˆæŠ€èƒ½å¡ï¼‰
  "æŠ€èƒ½å¡_åˆ—è¡¨": ["å¡1", "å¡2", ...],  // JSONå­—ç¬¦ä¸²
  "Pé¥®æ–™_åˆ—è¡¨": ["é¥®æ–™1", ...],
}
```

#### APIä½¿ç”¨

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/utils/game-data.ts

// è¯»å–ç¾½çŸ³
const gems = getVariables({ type: 'global' })['å¶åƒå¤§å¸ˆ_ç¾½çŸ³'];

// æ›´æ–°ç¾½çŸ³
replaceVariables({ 'å¶åƒå¤§å¸ˆ_ç¾½çŸ³': gems - 3000 }, { type: 'global' });

// è¯»å–å¥½æ„Ÿåº¦ï¼ˆå½“å‰è§’è‰²å¡ï¼‰
const affection = getVariables({ type: 'character' })['å¥½æ„Ÿåº¦'];

// æ›´æ–°å¥½æ„Ÿåº¦
replaceVariables({ 'å¥½æ„Ÿåº¦': affection + 10 }, { type: 'character' });

// è¯»å–åŸ¹è‚²çŠ¶æ€ï¼ˆå½“å‰èŠå¤©ï¼‰
const turn = getVariables({ type: 'chat' })['åŸ¹è‚²_å½“å‰å›åˆ'];

// æ›´æ–°åŸ¹è‚²çŠ¶æ€
replaceVariables({ 
  'åŸ¹è‚²_å½“å‰å›åˆ': turn + 1,
  'åŸ¹è‚²_ä½“åŠ›': 50
}, { type: 'chat' });
```

**ä¼˜åŠ¿**:
- âœ… ä¸éœ€è¦ IndexedDB å°è£…
- âœ… ä¸é…’é¦†åŠ©æ‰‹æ— ç¼é›†æˆ
- âœ… å¯ä»¥åœ¨ STScriptã€ä¸–ç•Œä¹¦ä¸­ç›´æ¥å¼•ç”¨
- âœ… è‡ªåŠ¨æŒä¹…åŒ–ï¼Œä¸éœ€è¦æ‰‹åŠ¨ä¿å­˜
- âœ… æ”¯æŒå¤šç”¨æˆ·ï¼ˆä¸åŒèŠå¤©æ–‡ä»¶éš”ç¦»ï¼‰

---

### 1.2 ä¸–ç•Œä¹¦æ¶æ„è®¾è®¡ âœ¨

#### ä¸–ç•Œä¹¦ç»“æ„

**åˆ›å»º SillyTavern ä¸–ç•Œä¹¦**: `å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©.json`

```json
{
  "name": "å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©",
  "description": "æ¸¸æˆæ ¸å¿ƒæ•°æ®ã€äººè®¾ã€æ€ç»´é“¾",
  "entries": [
    // ===== è§’è‰²äººè®¾æ¨¡å— =====
    {
      "uid": "mano_persona",
      "key": ["æ¨±æœ¨çœŸä¹ƒ", "mano"],
      "content": "[è§’è‰²ï¼šæ¨±æœ¨çœŸä¹ƒ]\næ€§æ ¼ï¼šæ¸©æŸ”ã€åŠªåŠ›ã€å†…å‘...\nç‰¹ç‚¹ï¼š...\nå£å¤´ç¦…ï¼š...",
      "order": 100,
      "enabled": true,
      "constant": true
    },
    {
      "uid": "hiori_persona",
      "key": ["é£é‡ç¯ç»‡", "hiori"],
      "content": "[è§’è‰²ï¼šé£é‡ç¯ç»‡]\næ€§æ ¼ï¼šå†·é™ã€ç†æ€§...",
      "order": 100,
      "enabled": true,
      "constant": true
    },
    // ... 28ä¸ªå¶åƒäººè®¾
    
    // ===== å¥½æ„Ÿåº¦è¡¨ç°æ¨¡å—ï¼ˆ10çº§ï¼‰ =====
    {
      "uid": "affection_lv1",
      "key": [],  // ä¸è‡ªåŠ¨è§¦å‘
      "content": "[AIè¡¨ç°æŒ‡å¯¼-Lv1]\nç¤¼è²Œã€æ‹˜è°¨ã€ç§°å‘¼\"åˆ¶ä½œäºº\"ã€ä¿æŒè·ç¦»",
      "order": 90,
      "enabled": true,
      "constant": false
    },
    {
      "uid": "affection_lv5",
      "key": [],
      "content": "[AIè¡¨ç°æŒ‡å¯¼-Lv5]\näº²è¿‘ã€ä¼šåˆ†äº«å°ç§˜å¯†ã€å…³å¿ƒåˆ¶ä½œäººçš„èº«ä½“...",
      "order": 90,
      "enabled": true,
      "constant": false
    },
    {
      "uid": "affection_lv10",
      "key": [],
      "content": "[AIè¡¨ç°æŒ‡å¯¼-Lv10]\nç¾ç»Šã€è§†ä½ ä¸ºäººç”Ÿæœ€é‡è¦çš„äººã€ä¼šè¯´å‡ºå¿ƒåº•æœ€æ·±çš„è¯...",
      "order": 90,
      "enabled": true,
      "constant": false
    },
    
    // ===== æ€ç»´é“¾æ¨¡å—ï¼ˆä¸åŒåœºæ™¯ï¼‰ =====
    {
      "uid": "cot_skill_card_generation",
      "key": [],
      "content": "[æ€ç»´é“¾ï¼šæŠ€èƒ½å¡ç”Ÿæˆ]\n1. åˆ†æè§’è‰²ç‰¹ç‚¹å’Œå¡é¢ä¸»é¢˜\n2. ç¡®å®šç¨€æœ‰åº¦å¯¹åº”çš„å¼ºåº¦èŒƒå›´\n3. å‚è€ƒç¤ºä¾‹å¡ç‰Œçš„æ•ˆæœæ¨¡å¼\n4. è®¾è®¡ç¬¦åˆä¸»é¢˜çš„æŠ€èƒ½åç§°\n5. å¹³è¡¡costå’Œeffect\n6. è¾“å‡ºJSONæ ¼å¼",
      "order": 95,
      "enabled": false,  // é»˜è®¤ç¦ç”¨ï¼ŒæŒ‰éœ€å¯ç”¨
      "constant": false
    },
    {
      "uid": "cot_story_generation",
      "key": [],
      "content": "[æ€ç»´é“¾ï¼šå‰§æƒ…ç”Ÿæˆ]\n1. ç†è§£å½“å‰åœºæ™¯å’Œè§’è‰²çŠ¶æ€\n2. æ ¹æ®å¥½æ„Ÿåº¦ç¡®å®šè¯­æ°”å’Œè¡Œä¸º\n3. ç»“åˆåœ°ç‚¹ç‰¹è‰²è®¾è®¡æƒ…èŠ‚\n4. æ³¨æ„å‰§æƒ…çš„æƒ…æ„Ÿèµ·ä¼\n5. è®¡ç®—åˆç†çš„å¥–åŠ±æ•°å€¼\n6. è¾“å‡ºå‰§æƒ…+rewardæ ‡ç­¾",
      "order": 95,
      "enabled": false,
      "constant": false
    },
    
    // ===== ç¤ºä¾‹å¡ç‰Œæ¨¡å—ï¼ˆå†…ç½®åœ¨ä¸–ç•Œä¹¦ï¼‰ =====
    {
      "uid": "example_r_vocal",
      "key": [],
      "content": "[ç¤ºä¾‹-Rå¡-Vocal]\n{\"name\":\"æ·±å‘¼å¸\",\"cost\":1,\"type\":\"Support\",\"description\":\"è·å¾—10 Hype\"}",
      "order": 85,
      "enabled": false,
      "constant": false
    },
    {
      "uid": "example_ssr_vocal",
      "key": [],
      "content": "[ç¤ºä¾‹-SSRå¡-Vocal]\n{\"name\":\"èˆå°æ”¯é…\",\"cost\":4,\"type\":\"Attack\",\"description\":\"è·å¾— [Dance] x 4.0 çš„åˆ†æ•°ã€‚å¦‚æœHypeè¶…è¿‡50ï¼Œé¢å¤–è·å¾— [Dance] x 2.0\"}",
      "order": 85,
      "enabled": false,
      "constant": false
    },
    // ... æ›´å¤šç¤ºä¾‹å¡ç‰Œ
    
    // ===== åœ°ç‚¹æè¿°æ¨¡å— =====
    {
      "uid": "location_beach",
      "key": ["æµ·æ»©", "beach"],
      "content": "[åœ°ç‚¹ï¼šæµ·æ»©]\né˜³å…‰æ˜åªšï¼Œæµ·é£è½»æ‹‚...\næ°›å›´ï¼šè½»æ¾ã€æµªæ¼«\né€‚åˆæ´»åŠ¨ï¼šæ¸¸æ³³ã€æ•£æ­¥ã€è°ˆå¿ƒ",
      "order": 80,
      "enabled": true,
      "constant": false
    },
    
    // ===== æ‰®æ¼”è¦æ±‚ =====
    {
      "uid": "roleplay_requirements",
      "key": [],
      "content": "[æ‰®æ¼”è¦æ±‚]\n- ä½¿ç”¨ç¬¬äºŒäººç§°ï¼ˆä½ ï¼‰ç§°å‘¼åˆ¶ä½œäºº\n- å›å¤ç®€çŸ­ç²¾ç‚¼ï¼ˆ50-150å­—ï¼‰\n- ç¬¦åˆè§’è‰²æ€§æ ¼\n- ä½“ç°å½“å‰å¥½æ„Ÿåº¦ç­‰çº§\n- ä½¿ç”¨å£å¤´ç¦…å’Œç‰¹è‰²ç”¨è¯",
      "order": 110,
      "enabled": true,
      "constant": true
    },
    
    // ===== å‰§æƒ…æ¨è¿›è¦æ±‚ï¼ˆåœºæ™¯ç›¸å…³ï¼‰ =====
    {
      "uid": "story_requirements_training",
      "key": [],
      "content": "[å‰§æƒ…æ¨è¿›-è®­ç»ƒ]\n- æ ¹æ®è®­ç»ƒç»“æœï¼ˆPerfect/Clear/Failï¼‰è¡¨ç°è§’è‰²ååº”\n- ä½“ç°è§’è‰²å¯¹æŠ€èƒ½æå‡çš„æ€åº¦\n- ç»“å°¾ç»™å‡ºå¥–åŠ±ï¼š<reward>{\"stamina\":5,\"love\":2}</reward>",
      "order": 105,
      "enabled": false,
      "constant": false
    },
    {
      "uid": "story_requirements_activity",
      "key": [],
      "content": "[å‰§æƒ…æ¨è¿›-è‡ªç”±æ´»åŠ¨]\n- ç»“åˆåœ°ç‚¹ç‰¹è‰²è®¾è®¡æƒ…èŠ‚\n- ä½“ç°è§’è‰²ä¸åˆ¶ä½œäººçš„äº’åŠ¨\n- ç»“å°¾ç»™å‡ºå¥–åŠ±ï¼š<reward>{\"stamina\":10,\"love\":5}</reward>",
      "order": 105,
      "enabled": false,
      "constant": false
    }
  ]
}
```

#### åŠ¨æ€å¯ç”¨ä¸–ç•Œä¹¦æ¡ç›®

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/utils/worldbook-manager.ts

/**
 * æ ¹æ®åœºæ™¯å¯ç”¨ä¸åŒçš„ä¸–ç•Œä¹¦æ¡ç›®
 */
export async function configureWorldbookForScene(scene: 'skill_generation' | 'training' | 'activity' | 'ending') {
  const worldbook = await getWorldbook('å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©');
  
  // ç¦ç”¨æ‰€æœ‰åœºæ™¯ç›¸å…³çš„æ¡ç›®
  disableAllSceneEntries(worldbook);
  
  switch (scene) {
    case 'skill_generation':
      // å¯ç”¨æŠ€èƒ½å¡ç”Ÿæˆæ€ç»´é“¾
      enableEntry(worldbook, 'cot_skill_card_generation');
      // å¯ç”¨ç¤ºä¾‹å¡ç‰Œ
      enableEntry(worldbook, 'example_r_vocal');
      enableEntry(worldbook, 'example_sr_vocal');
      enableEntry(worldbook, 'example_ssr_vocal');
      enableEntry(worldbook, 'example_ur_vocal');
      break;
      
    case 'training':
      // å¯ç”¨å‰§æƒ…ç”Ÿæˆæ€ç»´é“¾
      enableEntry(worldbook, 'cot_story_generation');
      // å¯ç”¨è®­ç»ƒå‰§æƒ…æ¨è¿›è¦æ±‚
      enableEntry(worldbook, 'story_requirements_training');
      // æ ¹æ®å¥½æ„Ÿåº¦å¯ç”¨å¯¹åº”çš„AIè¡¨ç°æŒ‡å¯¼
      const affection = getVariables({ type: 'character' })['å¥½æ„Ÿåº¦'];
      const level = Math.floor(affection / 200) + 1;
      enableEntry(worldbook, `affection_lv${Math.min(level, 10)}`);
      break;
      
    case 'activity':
      enableEntry(worldbook, 'cot_story_generation');
      enableEntry(worldbook, 'story_requirements_activity');
      const affection2 = getVariables({ type: 'character' })['å¥½æ„Ÿåº¦'];
      const level2 = Math.floor(affection2 / 200) + 1;
      enableEntry(worldbook, `affection_lv${Math.min(level2, 10)}`);
      break;
      
    case 'ending':
      enableEntry(worldbook, 'cot_story_generation');
      enableEntry(worldbook, 'affection_lv10');  // ç»“å±€æ€»æ˜¯æœ€é«˜å¥½æ„Ÿåº¦
      break;
  }
  
  // ä¿å­˜ä¸–ç•Œä¹¦
  await setWorldbook('å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©', worldbook);
}
```

**ä¼˜åŠ¿**:
- âœ… äººè®¾ã€æ€ç»´é“¾ã€ç¤ºä¾‹éƒ½åœ¨ä¸–ç•Œä¹¦ä¸­ï¼Œæ˜“äºè°ƒæ•´
- âœ… ä¸åŒåœºæ™¯åŠ¨æ€å¯ç”¨ä¸åŒæ¡ç›®ï¼ŒTokené«˜æ•ˆ
- âœ… ç”¨æˆ·å¯ä»¥è‡ªå·±ä¿®æ”¹ä¸–ç•Œä¹¦å†…å®¹ï¼Œé«˜åº¦å¯å®šåˆ¶
- âœ… ç‰ˆæœ¬æ§åˆ¶å‹å¥½ï¼ˆJSONæ–‡ä»¶ï¼‰
- âœ… æ”¯æŒå¯¼å…¥å¯¼å‡ºï¼Œæ–¹ä¾¿åˆ†äº«

---

### 1.3 äº‹ä»¶ç›‘å¬ç³»ç»Ÿé‡æ„ âœ¨

**å®Œå…¨ä¸éœ€è¦è‡ªå·±å®ç° iframe é€šä¿¡ï¼**

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/utils/event-listeners.ts

import { eventOn, tavern_events } from 'é…’é¦†åŠ©æ‰‹API';

/**
 * ç›‘å¬AIæ¶ˆæ¯æ¥æ”¶äº‹ä»¶
 */
export function setupMessageListener() {
  eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {
    const message = SillyTavern.chat[messageId];
    const text = message.mes;
    
    // è§£æå¥–åŠ±æ ‡ç­¾
    const rewardMatch = text.match(/<reward>(.*?)<\/reward>/);
    if (rewardMatch) {
      const rewards = JSON.parse(rewardMatch[1]);
      await applyRewards(rewards);
    }
    
    // è§£æè¡¨æƒ…æ ‡ç­¾ï¼ˆSpineåŠ¨ç”»ï¼‰
    const emotionMatch = text.match(/<emotion>(.*?)<\/emotion>/);
    if (emotionMatch) {
      await playSpineAnimation(emotionMatch[1]);
    }
    
    // è§£æèƒŒæ™¯æ ‡ç­¾
    const bgMatch = text.match(/<background>(.*?)<\/background>/);
    if (bgMatch) {
      await changeBackground(bgMatch[1]);
    }
  });
}

/**
 * ç›‘å¬èŠå¤©å˜æ›´ï¼ˆåŸ¹è‚²ä¼šè¯åˆ‡æ¢ï¼‰
 */
export function setupChatChangeListener() {
  eventOn(tavern_events.CHAT_CHANGED, (newChatId: string) => {
    // é‡æ–°åŠ è½½åŸ¹è‚²çŠ¶æ€
    loadProduceState(newChatId);
  });
}

/**
 * ç›‘å¬è§’è‰²åˆ‡æ¢ï¼ˆå¶åƒåˆ‡æ¢ï¼‰
 */
export function setupCharacterChangeListener() {
  eventOn(tavern_events.CHARACTER_CHANGED, (newCharacterId: string) => {
    // æ›´æ–°ä¸»é¡µé¢æ˜¾ç¤ºçš„å¶åƒ
    updateMainPageIdol(newCharacterId);
  });
}
```

**ä¼˜åŠ¿**:
- âœ… ä¸éœ€è¦ postMessageã€ä¸éœ€è¦ loader è„šæœ¬
- âœ… ç›´æ¥ç›‘å¬é…’é¦†äº‹ä»¶ï¼Œä»£ç ç®€æ´
- âœ… è‡ªåŠ¨ä¸é…’é¦†åŒæ­¥
- âœ… æ”¯æŒæ‰€æœ‰é…’é¦†äº‹ä»¶ï¼ˆ100+ç§ï¼‰

---

### 1.4 è„šæœ¬ç³»ç»Ÿè®¾è®¡ âœ¨

**åˆ›å»ºåå°è„šæœ¬**: `src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts/`

#### è„šæœ¬1ï¼šSpineåŠ¨ç”»æ§åˆ¶å™¨

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts/spine-controller.ts

import { eventOn, tavern_events } from 'é…’é¦†åŠ©æ‰‹API';

/**
 * ç›‘å¬AIæ¶ˆæ¯ï¼Œè‡ªåŠ¨æ’­æ”¾SpineåŠ¨ç”»
 */
eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {
  const message = SillyTavern.chat[messageId];
  const text = message.mes;
  
  // æ£€æµ‹æƒ…ç»ªå…³é”®è¯
  const emotions = {
    'é«˜å…´': 'Emotion_Happy',
    'å¼€å¿ƒ': 'Emotion_Happy',
    'ç¬‘': 'Emotion_Happy',
    'éš¾è¿‡': 'Emotion_Sad',
    'ä¼¤å¿ƒ': 'Emotion_Sad',
    'æƒŠè®¶': 'Emotion_Surprise',
    'å®³ç¾': 'Emotion_Shy',
    'ç”Ÿæ°”': 'Emotion_Angry',
  };
  
  // è‡ªåŠ¨æ£€æµ‹å¹¶æ’­æ”¾åŠ¨ç”»
  for (const [keyword, animation] of Object.entries(emotions)) {
    if (text.includes(keyword)) {
      // é€šçŸ¥å‰ç«¯ç•Œé¢æ’­æ”¾SpineåŠ¨ç”»
      window.postMessage({
        type: 'PLAY_SPINE_ANIMATION',
        payload: { animation }
      }, '*');
      break;
    }
  }
  
  // è§£æ <emotion> æ ‡ç­¾
  const emotionMatch = text.match(/<emotion>(.*?)<\/emotion>/);
  if (emotionMatch) {
    const emotion = emotionMatch[1];
    window.postMessage({
      type: 'PLAY_SPINE_ANIMATION',
      payload: { animation: emotions[emotion] || 'Idle' }
    }, '*');
  }
});
```

#### è„šæœ¬2ï¼šèƒŒæ™¯åˆ‡æ¢æ§åˆ¶å™¨

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts/background-controller.ts

import { eventOn, tavern_events } from 'é…’é¦†åŠ©æ‰‹API';

const backgrounds = {
  'æµ·æ»©': 'beach.jpg',
  'å›¾ä¹¦é¦†': 'library.jpg',
  'å’–å•¡å…': 'cafe.jpg',
  'å½•éŸ³å®¤': 'studio.jpg',
  'èˆè¹ˆå®¤': 'dance_room.jpg',
  'äº‹åŠ¡æ‰€': 'office.jpg',
};

eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {
  const message = SillyTavern.chat[messageId];
  const text = message.mes;
  
  // è‡ªåŠ¨æ£€æµ‹åœ°ç‚¹å…³é”®è¯
  for (const [keyword, bgImage] of Object.entries(backgrounds)) {
    if (text.includes(keyword)) {
      window.postMessage({
        type: 'CHANGE_BACKGROUND',
        payload: { background: bgImage }
      }, '*');
      break;
    }
  }
  
  // è§£æ <background> æ ‡ç­¾
  const bgMatch = text.match(/<background>(.*?)<\/background>/);
  if (bgMatch) {
    const bg = bgMatch[1];
    window.postMessage({
      type: 'CHANGE_BACKGROUND',
      payload: { background: backgrounds[bg] || 'default.jpg' }
    }, '*');
  }
});
```

#### è„šæœ¬3ï¼šè‡ªåŠ¨åŒ–åŸ¹è‚²æµç¨‹

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts/auto-produce.ts

import { eventOn, tavern_events, triggerSlash } from 'é…’é¦†åŠ©æ‰‹API';

/**
 * ç›‘å¬ç”¨æˆ·ç‚¹å‡»"è®­ç»ƒ"æŒ‰é’®
 * è‡ªåŠ¨è§¦å‘ä¸€ç³»åˆ—æµç¨‹
 */
window.addEventListener('message', async (event) => {
  if (event.data.type === 'ACTION_TRAINING') {
    const { lesson } = event.data.payload;
    
    // 1. æ›´æ–°åŸ¹è‚²å˜é‡
    const turn = getVariables({ type: 'chat' })['åŸ¹è‚²_å½“å‰å›åˆ'];
    replaceVariables({ 
      'åŸ¹è‚²_å½“å‰å›åˆ': turn + 1,
      'åŸ¹è‚²_æœ€åè¡ŒåŠ¨': 'training',
      'åŸ¹è‚²_è®­ç»ƒç±»å‹': lesson
    }, { type: 'chat' });
    
    // 2. é…ç½®ä¸–ç•Œä¹¦ï¼ˆå¯ç”¨è®­ç»ƒç›¸å…³æ¡ç›®ï¼‰
    await configureWorldbookForScene('training');
    
    // 3. å‘é€æç¤ºè¯ï¼ˆä½¿ç”¨Slash Commandï¼‰
    await triggerSlash(`/send åˆ¶ä½œäººå†³å®šè¿›è¡Œ${lesson}è®­ç»ƒã€‚è¯·ç”Ÿæˆè®­ç»ƒåçš„çŸ­å‰§æƒ…ï¼ˆ50å­—å†…ï¼‰ï¼Œå¹¶ç»™å‡ºå¥–åŠ±ã€‚`);
  }
});
```

**ä¼˜åŠ¿**:
- âœ… è„šæœ¬åœ¨åå°è¿è¡Œï¼Œä¸å½±å“å‰ç«¯ç•Œé¢
- âœ… å¯ä»¥ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼Œå®ç°è‡ªåŠ¨åŒ–
- âœ… å¯ä»¥ç›´æ¥è°ƒç”¨é…’é¦†API
- âœ… ç”¨æˆ·å¯ä»¥è‡ªå·±ä¿®æ”¹è„šæœ¬ï¼Œé«˜åº¦å¯å®šåˆ¶

---

### 1.5 jQueryæ³¨å…¥ç³»ç»Ÿ âœ¨

**åœ¨é…’é¦†ç•Œé¢æ³¨å…¥è‡ªå®šä¹‰å…ƒç´ **

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©/utils/ui-injector.ts

/**
 * åœ¨é…’é¦†ç•Œé¢æ³¨å…¥çŠ¶æ€æ 
 */
export function injectStatusBar() {
  const statusBar = $(`
    <div id="idolmaster-status-bar" style="
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      min-width: 200px;
    ">
      <div style="font-weight: bold; margin-bottom: 10px;">å¶åƒå¤§å¸ˆ é—ªè€€è‰²å½©</div>
      <div>
        <span>ğŸ’ ç¾½çŸ³: </span>
        <span id="gems-display">3000</span>
      </div>
      <div>
        <span>ğŸ‘¥ ç²‰ä¸: </span>
        <span id="fans-display">0</span>
      </div>
      <div>
        <span>â­ ç­‰çº§: </span>
        <span id="level-display">1</span>
      </div>
    </div>
  `);
  
  $('body').append(statusBar);
  
  // å®æ—¶æ›´æ–°
  watchEffect(() => {
    const gems = getVariables({ type: 'global' })['å¶åƒå¤§å¸ˆ_ç¾½çŸ³'];
    $('#gems-display').text(gems);
    
    const fans = getVariables({ type: 'global' })['å¶åƒå¤§å¸ˆ_ç²‰ä¸'];
    $('#fans-display').text(fans);
    
    const level = getVariables({ type: 'global' })['å¶åƒå¤§å¸ˆ_åˆ¶ä½œäººç­‰çº§'];
    $('#level-display').text(level);
  });
}

/**
 * åœ¨é…’é¦†ç•Œé¢æ³¨å…¥å¿«æ·æŒ‰é’®
 */
export function injectQuickButtons() {
  const buttonPanel = $(`
    <div id="idolmaster-quick-panel" style="
      position: fixed;
      bottom: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    ">
      <button class="quick-btn" data-action="gacha" style="...">ğŸ² æŠ½å¡</button>
      <button class="quick-btn" data-action="produce" style="...">ğŸŒŸ åŸ¹è‚²</button>
      <button class="quick-btn" data-action="music" style="...">ğŸµ éŸ³ä¹</button>
      <button class="quick-btn" data-action="collection" style="...">ğŸ“š å›¾é‰´</button>
    </div>
  `);
  
  $('body').append(buttonPanel);
  
  // ç»‘å®šäº‹ä»¶
  $('.quick-btn').on('click', function() {
    const action = $(this).data('action');
    handleQuickAction(action);
  });
}

/**
 * æ³¨å…¥åŸ¹è‚²å¿«æ·æŒ‰é’®ï¼ˆå½“å‰åœ¨åŸ¹è‚²æ¨¡å¼æ—¶ï¼‰
 */
export function injectProduceActions() {
  const actionsPanel = $(`
    <div id="produce-actions" style="...">
      <button class="produce-action" data-action="training-vocal">Vocalè®­ç»ƒ</button>
      <button class="produce-action" data-action="training-dance">Danceè®­ç»ƒ</button>
      <button class="produce-action" data-action="training-visual">Visualè®­ç»ƒ</button>
      <button class="produce-action" data-action="activity">è‡ªç”±æ´»åŠ¨</button>
      <button class="produce-action" data-action="rest">ä¼‘æ¯</button>
    </div>
  `);
  
  $('#send_textarea').before(actionsPanel);
  
  $('.produce-action').on('click', function() {
    const action = $(this).data('action');
    handleProduceAction(action);
  });
}
```

**ä¼˜åŠ¿**:
- âœ… è½»é‡çº§UIå…ƒç´ å¯ä»¥ç›´æ¥æ³¨å…¥é…’é¦†ç•Œé¢
- âœ… ä¸éœ€è¦å®Œæ•´çš„iframeï¼Œå‡å°‘èµ„æºå ç”¨
- âœ… ä¸é…’é¦†ç•Œé¢æ— ç¼èåˆ
- âœ… ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä½ç½®å’Œæ ·å¼

---

## Phase 2: æ ¸å¿ƒç©æ³•ï¼ˆæ··åˆæ¨¡å¼ï¼‰

**ç›®æ ‡**: é‡UIéƒ¨åˆ†ç”¨iframeï¼Œè½»é‡éƒ¨åˆ†ç”¨æ³¨å…¥  
**é¢„è®¡æ—¶é—´**: 6å‘¨ â¬ï¼ˆä»8-10å‘¨ç¼©çŸ­ï¼‰

### 2.1 æŠ½å¡ç³»ç»Ÿï¼ˆiframeæ¨¡å¼ï¼‰âœ…

**ä¿æŒåŸæœ‰å®ç°ï¼Œæ— éœ€æ›´æ”¹**

- âœ… ç‹¬ç«‹çš„Vueåº”ç”¨
- âœ… æ•°æ®è¯»å–/å†™å…¥æ”¹ç”¨é…’é¦†å˜é‡API
- âœ… å¡ç‰Œæ•°æ®ä¿æŒåœ¨ä»£ç ä¸­

### 2.2 å¡ç‰Œæˆ˜æ–—ç³»ç»Ÿï¼ˆiframeæ¨¡å¼ï¼‰âŒ

**ä¿æŒé‡UIæ¨¡å¼ï¼Œä½†æ•°æ®äº¤äº’æ”¹ç”¨é…’é¦†å˜é‡**

```typescript
// æ‰“ç‰Œç•Œé¢å¯åŠ¨æ—¶è¯»å–é…’é¦†å˜é‡
const stamina = getVariables({ type: 'chat' })['åŸ¹è‚²_ä½“åŠ›'];
const skillDeck = JSON.parse(getVariables({ type: 'script', script_id: getScriptId() })['æŠ€èƒ½å¡_åˆ—è¡¨']);

// æ‰“ç‰Œç»“æŸåå†™å›é…’é¦†å˜é‡
replaceVariables({
  'åŸ¹è‚²_ä½“åŠ›': finalStamina,
  'åŸ¹è‚²_VO': newVO,
}, { type: 'chat' });
```

### 2.3 åŸ¹è‚²ç³»ç»Ÿï¼ˆæ··åˆæ¨¡å¼ï¼‰âœ¨

**æ ¸å¿ƒæ€è·¯**: åŸ¹è‚²ç³»ç»Ÿä¸éœ€è¦å®Œæ•´çš„UIç•Œé¢ï¼

#### æ–¹æ¡ˆAï¼šQuick Replyæ¨¡å¼ï¼ˆæ¨èï¼‰

```typescript
// æ³¨å†ŒQuick Reply
registerQuickReply('Vocalè®­ç»ƒ', async () => {
  // 1. æ›´æ–°åŸ¹è‚²å˜é‡
  const turn = getVariables({ type: 'chat' })['åŸ¹è‚²_å½“å‰å›åˆ'];
  replaceVariables({ 
    'åŸ¹è‚²_å½“å‰å›åˆ': turn + 1,
    'åŸ¹è‚²_æœ€åè¡ŒåŠ¨': 'training',
    'åŸ¹è‚²_è®­ç»ƒç±»å‹': 'Vocal'
  }, { type: 'chat' });
  
  // 2. é…ç½®ä¸–ç•Œä¹¦
  await configureWorldbookForScene('training');
  
  // 3. æ‰“å¼€æ‰“ç‰Œç•Œé¢ï¼ˆiframeï¼‰
  const result = await openCardGame({ mode: 'training', type: 'Vocal' });
  
  // 4. å‘é€æç¤ºè¯è§¦å‘å‰§æƒ…
  await triggerSlash(`/send åˆ¶ä½œäººå†³å®šè¿›è¡ŒVocalè®­ç»ƒï¼Œæœ€ç»ˆè¯„ä»·ï¼š${result.evaluation}ã€‚è¯·ç”Ÿæˆè®­ç»ƒåçš„çŸ­å‰§æƒ…ã€‚`);
});

registerQuickReply('è‡ªç”±æ´»åŠ¨', async () => {
  // 1. æ˜¾ç¤ºåœ°ç‚¹é€‰æ‹©ï¼ˆç®€å•çš„confirmå¯¹è¯æ¡†æˆ–è‡ªå®šä¹‰å¼¹çª—ï¼‰
  const locations = ['æµ·æ»©', 'å›¾ä¹¦é¦†', 'å’–å•¡å…'];
  const location = await showLocationPicker(locations);
  
  // 2. æ›´æ–°å˜é‡
  replaceVariables({ 
    'åŸ¹è‚²_å½“å‰å›åˆ': turn + 1,
    'åŸ¹è‚²_æœ€åè¡ŒåŠ¨': 'activity',
    'åŸ¹è‚²_åœ°ç‚¹': location
  }, { type: 'chat' });
  
  // 3. é…ç½®ä¸–ç•Œä¹¦
  await configureWorldbookForScene('activity');
  
  // 4. å‘é€æç¤ºè¯
  await triggerSlash(`/send åˆ¶ä½œäººå’Œ{{char}}ä¸€èµ·æ¥åˆ°${location}ã€‚è¯·ç”Ÿæˆä¸€æ®µæ¸©é¦¨çš„äº’åŠ¨å‰§æƒ…ã€‚`);
});
```

#### æ–¹æ¡ˆBï¼šæ³¨å…¥æŒ‰é’®æ¨¡å¼

```typescript
// åœ¨èŠå¤©è¾“å…¥æ¡†ä¸Šæ–¹æ³¨å…¥åŸ¹è‚²æŒ‰é’®
injectProduceActions();

// ç‚¹å‡»æŒ‰é’®è§¦å‘ç›¸åŒæµç¨‹
$('#produce-action-training-vocal').on('click', async () => {
  // åŒä¸Š...
});
```

**ä¼˜åŠ¿**:
- âœ… ä¸éœ€è¦å®Œæ•´çš„åŸ¹è‚²UIç•Œé¢
- âœ… æ‰€æœ‰çŠ¶æ€æ˜¾ç¤ºç”¨æ³¨å…¥çš„çŠ¶æ€æ 
- âœ… è¡ŒåŠ¨é€‰æ‹©ç”¨Quick Replyæˆ–æ³¨å…¥æŒ‰é’®
- âœ… å‰§æƒ…ç›´æ¥æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ï¼ˆåŸç”ŸGalä½“éªŒï¼‰
- âœ… æ‰“ç‰Œéƒ¨åˆ†ä»ç„¶æ˜¯ç‹¬ç«‹iframeï¼ˆä¿æŒé‡UIä½“éªŒï¼‰

---

## Phase 3: AIå™äº‹ï¼ˆä¸–ç•Œä¹¦é©±åŠ¨ï¼‰

**ç›®æ ‡**: ä½¿ç”¨ä¸–ç•Œä¹¦å’ŒSTScriptå®ç°åŠ¨æ€å‰§æƒ…  
**é¢„è®¡æ—¶é—´**: 2å‘¨ â¬ï¼ˆä»3å‘¨ç¼©çŸ­ï¼‰

### 3.1 ä¸–ç•Œä¹¦é©±åŠ¨çš„å‰§æƒ…ç”Ÿæˆ âœ¨

**å®Œå…¨ä¸éœ€è¦æç¤ºè¯åŠ å·¥å‚ç±»ï¼**

```typescript
// è®­ç»ƒåå‰§æƒ…ç”Ÿæˆæµç¨‹

// 1. Vueåº”ç”¨è§¦å‘
async function handleTrainingComplete(result: TrainingResult) {
  // æ›´æ–°å˜é‡
  replaceVariables({
    'åŸ¹è‚²_æœ€åè®­ç»ƒç»“æœ': result.evaluation,
    'åŸ¹è‚²_æœ€åè®­ç»ƒç±»å‹': result.type,
    'åŸ¹è‚²_VO': currentStats.vo + result.voGain,
  }, { type: 'chat' });
  
  // 2. é…ç½®ä¸–ç•Œä¹¦ï¼ˆå¯ç”¨è®­ç»ƒç›¸å…³æ¡ç›®ï¼‰
  await configureWorldbookForScene('training');
  
  // 3. å‘é€æç¤ºè¯ï¼ˆç®€çŸ­å³å¯ï¼Œä¸–ç•Œä¹¦ä¼šè‡ªåŠ¨æ³¨å…¥ï¼‰
  await triggerSlash(`/send åˆ¶ä½œäººå†³å®šè¿›è¡Œ{{getvar::åŸ¹è‚²_æœ€åè®­ç»ƒç±»å‹}}è®­ç»ƒï¼Œæœ€ç»ˆè¯„ä»·ï¼š{{getvar::åŸ¹è‚²_æœ€åè®­ç»ƒç»“æœ}}ã€‚è¯·ç”Ÿæˆè®­ç»ƒåçš„çŸ­å‰§æƒ…ï¼ˆ50å­—å†…ï¼‰ï¼Œå¹¶ç»™å‡ºå¥–åŠ±ã€‚`);
}

// é…’é¦†ä¼šè‡ªåŠ¨ï¼š
// 1. è¯»å–ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆè§’è‰²äººè®¾ã€å¥½æ„Ÿåº¦è¡¨ç°ã€è®­ç»ƒå‰§æƒ…è¦æ±‚ã€æ€ç»´é“¾ï¼‰
// 2. ç»„è£…å®Œæ•´æç¤ºè¯
// 3. å‘é€ç»™AI
// 4. AIè¿”å›å‰§æƒ… + <reward>æ ‡ç­¾
// 5. äº‹ä»¶ç›‘å¬å™¨è‡ªåŠ¨è§£æå¥–åŠ±å¹¶åº”ç”¨
```

**ä¼˜åŠ¿**:
- âœ… ä¸éœ€è¦ `PromptFactory.ts`
- âœ… ä¸éœ€è¦ `lore/*.ts` æ–‡ä»¶ï¼ˆéƒ½åœ¨ä¸–ç•Œä¹¦ä¸­ï¼‰
- âœ… ç”¨æˆ·å¯ä»¥è‡ªå·±ä¿®æ”¹ä¸–ç•Œä¹¦å†…å®¹
- âœ… æ”¯æŒå¯¼å…¥å¯¼å‡ºï¼Œæ˜“äºåˆ†äº«
- âœ… æ‰€æœ‰è§’è‰²ã€åœºæ™¯çš„æç¤ºè¯é›†ä¸­ç®¡ç†

### 3.2 AIå¡ç‰Œç”Ÿæˆï¼ˆä¸–ç•Œä¹¦ + ä¸“ç”¨è§’è‰²å¡ï¼‰âœ¨

```typescript
// 1. åˆ›å»ºä¸“ç”¨è§’è‰²å¡ï¼š"æŠ€èƒ½å¡ç”ŸæˆBot"
// è§’è‰²è®¾å®šï¼š...ï¼ˆå‚è€ƒåŸå¤§çº²ï¼‰

// 2. åœ¨ä¸–ç•Œä¹¦ä¸­æ·»åŠ ç¤ºä¾‹å¡ç‰Œå’Œæ€ç»´é“¾ï¼ˆå·²å®Œæˆï¼‰

// 3. ç”Ÿæˆæµç¨‹
async function generateSkillCard(cardId: string) {
  const card = getCardById(cardId);
  
  // ä¿å­˜ä¸»è§’è‰²
  const mainCharacter = SillyTavern.getCurrentCharacter();
  
  // åˆ‡æ¢åˆ°ä¸“ç”¨Bot
  await triggerSlash(`/setchar æŠ€èƒ½å¡ç”ŸæˆBot`);
  
  // é…ç½®ä¸–ç•Œä¹¦ï¼ˆå¯ç”¨ç¤ºä¾‹å¡ç‰Œå’Œæ€ç»´é“¾ï¼‰
  await configureWorldbookForScene('skill_generation');
  
  // å‘é€è¯·æ±‚ï¼ˆç®€çŸ­å³å¯ï¼Œä¸–ç•Œä¹¦ä¼šæ³¨å…¥ç¤ºä¾‹ï¼‰
  await triggerSlash(`/send è¯·ä¸ºã€${card.characterName}ã€‘çš„ã€${card.theme}ã€‘å¡é¢è®¾è®¡ä¸€å¼ ${card.rarity}ç¨€æœ‰åº¦çš„æŠ€èƒ½å¡ã€‚å±æ€§ï¼š${card.attribute}`);
  
  // ç›‘å¬å›å¤ï¼ˆåœ¨äº‹ä»¶ç›‘å¬å™¨ä¸­å¤„ç†ï¼‰
  eventOn(tavern_events.MESSAGE_RECEIVED, (messageId) => {
    const text = SillyTavern.chat[messageId].mes;
    try {
      const skill = JSON.parse(text);
      saveSkillCard(cardId, skill);
      
      // åˆ‡å›ä¸»è§’è‰²
      triggerSlash(`/setchar ${mainCharacter}`);
    } catch (e) {
      // é‡è¯•
    }
  }, { once: true });
}
```

---

## Phase 4: å†…å®¹å¡«å……ï¼ˆè„šæœ¬è‡ªåŠ¨åŒ–ï¼‰

**ç›®æ ‡**: åˆ©ç”¨è„šæœ¬å®ç°è‡ªåŠ¨åŒ–å’Œé«˜çº§åŠŸèƒ½  
**é¢„è®¡æ—¶é—´**: 3å‘¨ â¬ï¼ˆä»4å‘¨ç¼©çŸ­ï¼‰

### 4.1 SpineåŠ¨ç”»ç³»ç»Ÿï¼ˆè„šæœ¬é©±åŠ¨ï¼‰âœ¨

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts/spine-advanced.ts

/**
 * é«˜çº§Spineæ§åˆ¶ï¼šæ ¹æ®å‰§æƒ…ä¸Šä¸‹æ–‡è‡ªåŠ¨é€‰æ‹©åŠ¨ç”»
 */
eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {
  const message = SillyTavern.chat[messageId];
  const text = message.mes;
  
  // æƒ…æ„Ÿåˆ†æï¼ˆç®€å•ç‰ˆï¼‰
  const sentimentScore = analyzeSentiment(text);
  
  if (sentimentScore > 0.7) {
    // éå¸¸ç§¯æ â†’ å¼€å¿ƒåŠ¨ç”»
    playSpineAnimation('Emotion_Happy');
  } else if (sentimentScore < -0.7) {
    // éå¸¸æ¶ˆæ â†’ éš¾è¿‡åŠ¨ç”»
    playSpineAnimation('Emotion_Sad');
  } else if (text.includes('ï¼Ÿ') || text.includes('?')) {
    // ç–‘é—® â†’ ç–‘æƒ‘åŠ¨ç”»
    playSpineAnimation('Emotion_Confusion');
  } else {
    // ä¸­æ€§ â†’ è¯´è¯åŠ¨ç”»
    playSpineAnimation('Talk_01');
  }
});

/**
 * ç‚¹å‡»äº¤äº’åŠ¨ç”»
 */
function setupSpineInteraction() {
  $('.spine-character').on('click', (event) => {
    const clickY = event.offsetY;
    const height = $(event.target).height();
    
    if (clickY < height * 0.3) {
      // ç‚¹å‡»å¤´éƒ¨
      playSpineAnimation('Touch_Head');
    } else if (clickY > height * 0.7) {
      // ç‚¹å‡»ä¸‹åŠèº«
      playSpineAnimation('Touch_Body');
    } else {
      // ç‚¹å‡»ä¸­é—´
      playSpineAnimation('Touch_Hand');
    }
  });
}
```

### 4.2 èƒŒæ™¯éŸ³ä¹ç³»ç»Ÿï¼ˆè„šæœ¬é©±åŠ¨ï¼‰âœ¨

```typescript
// src/å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts/music-controller.ts

/**
 * æ ¹æ®åœºæ™¯è‡ªåŠ¨åˆ‡æ¢BGM
 */
eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {
  const message = SillyTavern.chat[messageId];
  const text = message.mes;
  
  // æ£€æµ‹åœºæ™¯å…³é”®è¯
  const bgm_map = {
    'æµ·æ»©': 'beach_bgm.mp3',
    'æ¯”èµ›': 'battle_bgm.mp3',
    'è®­ç»ƒ': 'training_bgm.mp3',
    'ç»“å±€': 'ending_bgm.mp3',
  };
  
  for (const [keyword, bgm] of Object.entries(bgm_map)) {
    if (text.includes(keyword)) {
      await playBackgroundMusic(bgm);
      break;
    }
  }
});
```

### 4.3 å¥½æ„Ÿåº¦ç³»ç»Ÿï¼ˆé…’é¦†å˜é‡ + ä¸–ç•Œä¹¦ï¼‰âœ¨

```typescript
// å¥½æ„Ÿåº¦å­˜å‚¨åœ¨è§’è‰²å¡å˜é‡ä¸­
replaceVariables({ 'å¥½æ„Ÿåº¦': 100 }, { type: 'character' });

// æ¯æ¬¡AIäº¤äº’å‰ï¼ŒåŠ¨æ€å¯ç”¨å¯¹åº”ç­‰çº§çš„ä¸–ç•Œä¹¦æ¡ç›®
const affection = getVariables({ type: 'character' })['å¥½æ„Ÿåº¦'];
const level = Math.floor(affection / 200) + 1;

await configureWorldbookForScene('training');  // å…ˆé…ç½®åœºæ™¯
await enableEntry(worldbook, `affection_lv${Math.min(level, 10)}`);  // å†å¯ç”¨å¥½æ„Ÿåº¦

// AIä¼šè‡ªåŠ¨æ ¹æ®ä¸–ç•Œä¹¦ä¸­çš„"AIè¡¨ç°æŒ‡å¯¼"è°ƒæ•´è¯­æ°”å’Œè¡Œä¸º
```

---

## Phase 5: ä¼˜åŒ–ä¸å®Œå–„

**ä¸åŸå¤§çº²ç›¸åŒï¼Œç•¥**

---

## ğŸ“Š æ–°æ—§æ¶æ„å¯¹æ¯”

| æ–¹é¢           | æ—§æ¶æ„                      | æ–°æ¶æ„                 | æ”¹å–„           |
| -------------- | --------------------------- | ---------------------- | -------------- |
| **æ•°æ®å­˜å‚¨**   | IndexedDB + è‡ªå·±å°è£…        | é…’é¦†å˜é‡API            | â¬ ä»£ç é‡-80%   |
| **äº‹ä»¶ç›‘å¬**   | postMessage + loaderè„šæœ¬    | eventOné…’é¦†äº‹ä»¶        | â¬ ä»£ç é‡-90%   |
| **æç¤ºè¯ç®¡ç†** | PromptFactoryç±» + lore/*.ts | ä¸–ç•Œä¹¦JSON             | â¬ ä»£ç é‡-70%   |
| **UIå‘ˆç°**     | å…¨iframe                    | iframe + jQueryæ³¨å…¥    | â¬ èµ„æºå ç”¨-50% |
| **åŸ¹è‚²ç³»ç»Ÿ**   | å®Œæ•´Vueç•Œé¢                 | Quick Reply + æ³¨å…¥æŒ‰é’® | â¬ ä»£ç é‡-80%   |
| **Spineæ§åˆ¶**  | æ‰‹åŠ¨è°ƒç”¨                    | è„šæœ¬è‡ªåŠ¨æ£€æµ‹           | âœ… è‡ªåŠ¨åŒ–       |
| **èƒŒæ™¯åˆ‡æ¢**   | æ‰‹åŠ¨è°ƒç”¨                    | è„šæœ¬è‡ªåŠ¨æ£€æµ‹           | âœ… è‡ªåŠ¨åŒ–       |
| **å¥½æ„Ÿåº¦**     | localStorage + æ‰‹åŠ¨æ’å…¥     | è§’è‰²å¡å˜é‡ + ä¸–ç•Œä¹¦    | âœ… è‡ªåŠ¨åŒ–       |
| **å¯å®šåˆ¶æ€§**   | éœ€è¦æ”¹ä»£ç                   | æ”¹ä¸–ç•Œä¹¦/è„šæœ¬          | âœ… ç”¨æˆ·å‹å¥½     |
| **å¼€å‘æ—¶é—´**   | 5-6ä¸ªæœˆ                     | 3-4ä¸ªæœˆ                | â¬ æ—¶é—´-40%     |

---

## ğŸ¯ æ–°æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿

### 1. **å¼€å‘æ•ˆç‡æš´å¢**
- ä¸å†é‡å¤é€ è½®å­
- å¤§é‡ç°æˆAPIå¯ç”¨
- ä»£ç é‡å‡å°‘60-80%

### 2. **ç”¨æˆ·ä½“éªŒæå‡**
- ä¸é…’é¦†æ— ç¼é›†æˆ
- ä¸éœ€è¦å¤æ‚çš„è®¾ç½®
- æ”¯æŒå¤šç”¨æˆ·ï¼ˆä¸åŒèŠå¤©éš”ç¦»ï¼‰

### 3. **å¯ç»´æŠ¤æ€§æå‡**
- äººè®¾ã€æç¤ºè¯åœ¨ä¸–ç•Œä¹¦ä¸­ï¼Œæ˜“äºä¿®æ”¹
- è„šæœ¬ç‹¬ç«‹ï¼Œæ˜“äºè°ƒè¯•
- ç”¨æˆ·å¯ä»¥è‡ªå·±å®šåˆ¶

### 4. **åˆ†å‘ä¾¿åˆ©æ€§**
- ä¸€ä¸ªä¸–ç•Œä¹¦JSONæ–‡ä»¶
- å‡ ä¸ªè„šæœ¬æ–‡ä»¶
- ä¸€ä¸ªiframeï¼ˆæŠ½å¡/æ‰“ç‰Œï¼‰
- ç”¨æˆ·å¯¼å…¥å³ç”¨

### 5. **æ€§èƒ½æå‡**
- è½»é‡çº§å…ƒç´ æ³¨å…¥ï¼Œä¸éœ€è¦iframe
- æŒ‰éœ€åŠ è½½
- èµ„æºå ç”¨æ›´ä½

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### æœ¬å‘¨ï¼ˆç¬¬1å‘¨ï¼‰

1. **åˆ›å»ºä¸–ç•Œä¹¦æ–‡ä»¶**
   - 28ä¸ªå¶åƒäººè®¾
   - 10çº§å¥½æ„Ÿåº¦è¡¨ç°
   - 2å¥—æ€ç»´é“¾ï¼ˆåˆ¶å¡ã€å‰§æƒ…ï¼‰
   - ç¤ºä¾‹å¡ç‰Œï¼ˆR/SR/SSR/URå„1å¼ ï¼‰
   - æ‰®æ¼”è¦æ±‚ã€å‰§æƒ…æ¨è¿›è¦æ±‚

2. **å®ç°é…’é¦†å˜é‡é›†æˆ**
   - ä¿®æ”¹æŠ½å¡ç³»ç»Ÿï¼Œæ”¹ç”¨`getVariables`/`replaceVariables`
   - ä¿®æ”¹æ•°æ®å­˜å‚¨ï¼Œä»IndexedDBè¿ç§»åˆ°é…’é¦†å˜é‡

3. **å®ç°äº‹ä»¶ç›‘å¬**
   - ç›‘å¬MESSAGE_RECEIVEDè§£æå¥–åŠ±
   - ç›‘å¬CHAT_CHANGEDåŠ è½½åŸ¹è‚²çŠ¶æ€
   - ç›‘å¬CHARACTER_CHANGEDæ›´æ–°æ˜¾ç¤º

### ç¬¬2å‘¨

1. **å®ç°jQueryæ³¨å…¥**
   - çŠ¶æ€æ 
   - å¿«æ·æŒ‰é’®
   - åŸ¹è‚²è¡ŒåŠ¨æŒ‰é’®

2. **å®ç°ä¸–ç•Œä¹¦åŠ¨æ€é…ç½®**
   - `configureWorldbookForScene`å‡½æ•°
   - ä¸åŒåœºæ™¯çš„æ¡ç›®å¯ç”¨é€»è¾‘

3. **æµ‹è¯•åŸºç¡€æµç¨‹**
   - æŠ½å¡ â†’ ç¾½çŸ³æ‰£é™¤ â†’ å¡ç‰Œå…¥åº“
   - åˆ‡æ¢è§’è‰² â†’ çŠ¶æ€æ æ›´æ–°

### ç¬¬3-4å‘¨

1. **å®ç°è„šæœ¬ç³»ç»Ÿ**
   - Spineæ§åˆ¶è„šæœ¬
   - èƒŒæ™¯åˆ‡æ¢è„šæœ¬
   - è‡ªåŠ¨åŒ–åŸ¹è‚²è„šæœ¬

2. **æ‰“ç‰Œç³»ç»Ÿé›†æˆ**
   - è¯»å–é…’é¦†å˜é‡
   - å†™å›é…’é¦†å˜é‡

### ç¬¬5-8å‘¨

1. **å®ŒæˆåŸ¹è‚²ç³»ç»Ÿ**
2. **å®ŒæˆAIå‰§æƒ…ç”Ÿæˆ**
3. **å¡«å……å†…å®¹ï¼ˆåœ°ç‚¹ã€å‰§æœ¬ï¼‰**

---

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

```
E:\å¶åƒå¤§å¸ˆ\
â”œâ”€â”€ ä¸–ç•Œä¹¦\
â”‚   â””â”€â”€ å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©.json  ğŸ†• æ ¸å¿ƒä¸–ç•Œä¹¦
â”‚
â”œâ”€â”€ tavern_helper_template\
â”‚   â”œâ”€â”€ src\
â”‚   â”‚   â”œâ”€â”€ å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©\  (ä¸»åº”ç”¨ - æ³¨å…¥æ¨¡å¼)
â”‚   â”‚   â”‚   â”œâ”€â”€ utils\
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ game-data.ts  ğŸ”„ æ”¹ç”¨é…’é¦†å˜é‡API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ event-listeners.ts  ğŸ†• äº‹ä»¶ç›‘å¬
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ worldbook-manager.ts  ğŸ†• ä¸–ç•Œä¹¦ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ui-injector.ts  ğŸ†• jQueryæ³¨å…¥
â”‚   â”‚   â”‚   â””â”€â”€ app.vue  ğŸ”„ ç§»é™¤IndexedDBé€»è¾‘
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-gacha\  (æŠ½å¡ - iframeæ¨¡å¼)
â”‚   â”‚   â”‚   â””â”€â”€ utils\
â”‚   â”‚   â”‚       â””â”€â”€ storage.ts  ğŸ”„ æ”¹ç”¨é…’é¦†å˜é‡API
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-cardgame\  (æ‰“ç‰Œ - iframeæ¨¡å¼)
â”‚   â”‚   â”‚   â””â”€â”€ ...  ğŸ”„ æ•°æ®äº¤äº’æ”¹ç”¨é…’é¦†å˜é‡
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ å¶åƒå¤§å¸ˆé—ªè€€è‰²å½©-scripts\  ğŸ†• è„šæœ¬æ–‡ä»¶å¤¹
â”‚   â”‚       â”œâ”€â”€ spine-controller.ts
â”‚   â”‚       â”œâ”€â”€ background-controller.ts
â”‚   â”‚       â”œâ”€â”€ auto-produce.ts
â”‚   â”‚       â””â”€â”€ music-controller.ts
```

---

**å½“å‰çŠ¶æ€**: ğŸŸ¡ æ¶æ„é©æ–°å®Œæˆï¼Œç­‰å¾…å®æ–½  
**é¢„è®¡å®Œæˆæ—¶é—´**: 2026å¹´2æœˆï¼ˆæ¯”åŸè®¡åˆ’æå‰1-2ä¸ªæœˆï¼‰  
**æ ¸å¿ƒç†å¿µ**: **ä¸é‡å¤é€ è½®å­ï¼Œæœ€å¤§åŒ–åˆ©ç”¨é…’é¦†åŠ©æ‰‹ç”Ÿæ€** ğŸ¯



