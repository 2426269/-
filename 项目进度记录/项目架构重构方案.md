# 偶像大师闪耀色彩 - 项目架构重构方案

**文档版本**: v3.0 🆕 **彻底重构**  
**日期**: 2025-11-03  
**参考**: 哥布林游戏架构（中文命名 + 系统化分层）

---

## 🎯 重构核心理念

### 参考哥布林游戏架构的优点
1. ✅ **中文命名** - 直观易懂，便于团队协作
2. ✅ **系统化分层** - 按功能模块划分，职责清晰
3. ✅ **三层架构** - 服务/界面/类型 分离
4. ✅ **易于扩展** - 新增功能只需新增系统文件夹

### 旧架构的问题
- ❌ 英文命名混杂 - `gacha`, `cardgame` 等
- ❌ 功能混杂 - 一个文件夹包含多种职责
- ❌ 难以扩展 - 新增功能需要创建新的顶级文件夹
- ❌ 代码分散 - 数据、逻辑、UI 混在一起

---

## 📁 新架构设计

```
src/偶像大师闪耀色彩/
│
├── 📚 世界书管理/                    # 游戏核心数据
│   ├── 角色人设.ts                  # 28个偶像的人设
│   ├── 思维链.ts                    # 不同场景的AI思维链
│   ├── 示例卡牌.ts                  # 示例技能卡
│   ├── 地点描述.ts                  # 自由活动地点
│   ├── 扮演要求.ts                  # AI扮演规则
│   ├── 剧情推进要求.ts              # 剧情生成规则
│   └── 世界书同步服务.ts            # 与SillyTavern世界书同步
│
├── 👤 角色管理/                      # 偶像角色管理
│   ├── 角色数据.ts                  # 28个偶像的基础数据
│   ├── 角色服务.ts                  # 角色相关操作
│   ├── 角色类型.ts                  # 角色类型定义
│   └── 角色查询工具.ts              # 查询、过滤、排序
│
├── 🎴 卡牌管理/                      # 卡牌数据管理
│   ├── 全部卡牌数据.ts              # 200张P卡数据（现有的all-cards）
│   ├── 卡牌服务.ts                  # 卡牌CRUD操作
│   ├── 卡牌类型.ts                  # 卡牌接口定义
│   ├── 卡牌查询工具.ts              # 按稀有度、角色、属性查询
│   └── 卡牌URL构建器.ts             # 卡面图片URL生成
│
├── 🎰 抽卡/                          # 抽卡系统（重构后）
│   ├── 服务/
│   │   ├── 抽卡核心逻辑.ts          # 概率计算、保底机制
│   │   ├── 卡池管理服务.ts          # 卡池切换、UP卡设置
│   │   └── 抽卡历史服务.ts          # 历史记录管理
│   ├── 界面/
│   │   ├── 抽卡主界面.vue           # 主界面
│   │   ├── 抽卡动画.vue             # 抽卡动画
│   │   ├── 结果展示.vue             # 结果弹窗
│   │   ├── 卡池选择器.vue           # 卡池侧边栏
│   │   ├── 资源栏.vue               # 羽石、星尘显示
│   │   └── 概率说明弹窗.vue         # 概率说明
│   └── 类型/
│       ├── 抽卡类型.ts              # 抽卡相关接口
│       └── 卡池类型.ts              # 卡池配置接口
│
├── ⚔️ 战斗/                          # 卡牌战斗系统
│   ├── 服务/
│   │   ├── 战斗核心逻辑.ts          # 回合制逻辑
│   │   ├── 技能卡管理服务.ts        # 技能卡牌管理
│   │   ├── Buff管理服务.ts          # Buff系统
│   │   ├── 对手模拟服务.ts          # AI对手
│   │   └── 数值平衡配置.ts          # 平衡参数
│   ├── 界面/
│   │   ├── 战斗主界面.vue           # 战斗界面
│   │   ├── 技能卡组件.vue           # 技能卡展示
│   │   ├── Buff栏组件.vue           # Buff显示
│   │   ├── 状态栏组件.vue           # 体力、元气、得分
│   │   └── 应援效果组件.vue         # 应援提示
│   └── 类型/
│       ├── 战斗类型.ts              # 战斗相关接口
│       ├── 技能卡类型.ts            # 技能卡接口
│       └── Buff类型.ts              # Buff接口
│
├── 🌟 培育/                          # 培育系统
│   ├── 服务/
│   │   ├── 培育会话管理.ts          # 培育会话状态
│   │   ├── 剧本管理服务.ts          # 6个剧本数据
│   │   ├── 回合推进服务.ts          # 回合逻辑
│   │   ├── 训练服务.ts              # 训练相关
│   │   ├── 自由活动服务.ts          # 自由活动
│   │   ├── 比赛服务.ts              # 中间/最终比赛
│   │   └── 评价计算服务.ts          # 培育评价
│   ├── 界面/
│   │   ├── 培育主界面.vue           # 培育总控界面
│   │   ├── 行动选择器.vue           # 训练/活动/休息按钮
│   │   ├── 属性展示.vue             # VO/DA/VI显示
│   │   ├── 地图选择器.vue           # 自由活动地点选择
│   │   └── 评价结果界面.vue         # 培育结束评价
│   └── 类型/
│       ├── 培育类型.ts              # 培育相关接口
│       ├── 剧本类型.ts              # 剧本配置接口
│       └── 评价类型.ts              # 评价计算接口
│
├── 🎵 音乐/                          # 音乐播放系统（已完成）
│   ├── 音乐播放器.ts                # 播放器核心
│   ├── 歌曲数据.ts                  # 194首歌曲
│   ├── 歌词同步.ts                  # 歌词显示
│   └── 音乐界面.vue                 # 播放器UI
│
├── 📖 图鉴/                          # 偶像图鉴
│   ├── 服务/
│   │   ├── 图鉴数据服务.ts          # 图鉴数据管理
│   │   ├── 筛选服务.ts              # 按稀有度、角色筛选
│   │   └── 排序服务.ts              # 排序逻辑
│   ├── 界面/
│   │   ├── 图鉴主界面.vue           # 图鉴网格
│   │   ├── 卡牌详情弹窗.vue         # 详情展示（含觉醒）
│   │   ├── 全屏查看.vue             # 全屏卡面
│   │   └── 筛选器.vue               # 筛选条件UI
│   └── 类型/
│       └── 图鉴类型.ts              # 图鉴相关接口
│
├── 💖 好感度/                        # 好感度系统
│   ├── 服务/
│   │   ├── 好感度管理服务.ts        # 好感度CRUD
│   │   ├── 好感度剧情服务.ts        # 特殊剧情解锁
│   │   └── 好感度等级配置.ts        # 10级配置
│   ├── 界面/
│   │   ├── 好感度界面.vue           # 偶像列表+进度条
│   │   └── 好感度剧情播放器.vue     # 剧情播放
│   └── 类型/
│       └── 好感度类型.ts            # 好感度接口
│
├── 💾 存档管理/                      # 数据持久化
│   ├── 酒馆变量适配器.ts            # 酒馆变量API封装
│   ├── 全局变量服务.ts              # 羽石、粉丝、等级
│   ├── 角色变量服务.ts              # 好感度（角色卡变量）
│   ├── 聊天变量服务.ts              # 培育状态（聊天变量）
│   ├── 脚本变量服务.ts              # 技能卡（脚本变量）
│   ├── 数据迁移工具.ts              # 从localStorage迁移
│   └── 类型/
│       └── 存档类型.ts              # 存档相关接口
│
├── 🔄 资源同步/                      # 与酒馆同步
│   ├── 世界书同步服务.ts            # 世界书读写
│   ├── 变量同步服务.ts              # 变量实时同步
│   ├── 角色切换监听器.ts            # 监听角色切换
│   └── 聊天切换监听器.ts            # 监听聊天切换
│
├── 📡 事件监听/                      # 酒馆事件监听
│   ├── 消息接收监听器.ts            # MESSAGE_RECEIVED
│   ├── 奖励解析器.ts                # 解析<reward>标签
│   ├── 表情解析器.ts                # 解析<emotion>标签
│   └── 背景解析器.ts                # 解析<background>标签
│
├── 🎬 动画/                          # Spine动画系统
│   ├── 服务/
│   │   ├── Spine资源加载器.ts       # 资源按需加载
│   │   ├── 动画管理器.ts            # 动画切换
│   │   ├── 情感检测器.ts            # 自动检测情绪关键词
│   │   └── 交互动画控制器.ts        # 点击交互
│   ├── 界面/
│   │   └── Spine角色组件.vue        # 通用Spine组件
│   └── 类型/
│       └── Spine类型.ts             # Spine相关接口
│
├── 🎞️ 视频/                          # Live视频系统
│   ├── 视频播放器.vue               # 视频播放组件
│   ├── 视频映射表.ts                # 视频URL映射
│   └── 真结局判定.ts                # 真结局条件判定
│
├── 🛠️ 服务/                          # 通用服务
│   ├── AI服务.ts                    # AI请求封装
│   ├── 技能卡生成服务.ts            # AI生成技能卡
│   ├── 剧情生成服务.ts              # AI生成剧情
│   └── 场景配置服务.ts              # 世界书场景配置
│
├── 🧩 组件/                          # 通用UI组件
│   ├── 按钮组件.vue                 # 通用按钮
│   ├── 弹窗组件.vue                 # 通用弹窗
│   ├── 加载动画.vue                 # 加载提示
│   ├── 四格漫画加载页.vue           # 技能卡生成加载
│   └── Gal对话框.vue                # 剧情对话框
│
├── 📐 类型/                          # 全局类型定义
│   ├── 游戏数据类型.ts              # 游戏核心数据接口
│   ├── 酒馆接口类型.ts              # SillyTavern接口
│   └── 事件类型.ts                  # 事件相关接口
│
├── 🎨 样式/                          # 全局样式
│   ├── 变量.scss                    # CSS变量（颜色、字体）
│   ├── 混合.scss                    # Mixin工具
│   ├── 动画.scss                    # 通用动画
│   └── 重置.scss                    # 样式重置
│
├── 🔧 工具/                          # 工具函数
│   ├── 常量.ts                      # 游戏常量
│   ├── 格式化工具.ts                # 数字、日期格式化
│   ├── URL构建器.ts                 # CDN URL生成
│   ├── 图片缓存.ts                  # 图片预加载
│   └── 调试工具.ts                  # 开发调试
│
├── 📱 页面/                          # 主要页面
│   ├── 主页面.vue                   # 游戏主界面
│   ├── 设置页面.vue                 # 游戏设置
│   └── 关于页面.vue                 # 关于/帮助
│
├── 📦 脚本/                          # 酒馆助手脚本
│   ├── Spine控制脚本.ts             # 自动Spine动画
│   ├── 背景切换脚本.ts              # 自动背景切换
│   ├── 自动化培育脚本.ts            # 培育流程自动化
│   └── BGM控制脚本.ts               # 背景音乐控制
│
├── index.ts                         # 主入口
├── app.vue                          # 根组件
└── index.html                       # HTML模板
```

---

## 🔄 重构步骤

### Phase 1: 基础架构重构（第1周）

#### 1.1 创建新文件夹结构
```bash
# 在 src/ 下创建新的架构
mkdir 偶像大师闪耀色彩-新架构

# 创建所有系统文件夹
mkdir 世界书管理 角色管理 卡牌管理 抽卡 战斗 培育 音乐 图鉴 好感度 存档管理 资源同步 事件监听 动画 视频 服务 组件 类型 样式 工具 页面 脚本
```

#### 1.2 迁移现有代码

**优先级1：核心数据**
- [ ] 迁移 `all-cards.ts` → `卡牌管理/全部卡牌数据.ts`
- [ ] 迁移角色数据 → `角色管理/角色数据.ts`
- [ ] 创建类型定义 → `类型/游戏数据类型.ts`

**优先级2：抽卡系统**
- [ ] 迁移 `gacha-core-real.ts` → `抽卡/服务/抽卡核心逻辑.ts`
- [ ] 迁移抽卡组件 → `抽卡/界面/*.vue`
- [ ] 创建抽卡类型 → `抽卡/类型/抽卡类型.ts`

**优先级3：图鉴系统**
- [ ] 迁移 `IdolCollection.vue` → `图鉴/界面/图鉴主界面.vue`
- [ ] 提取觉醒逻辑 → `图鉴/服务/图鉴数据服务.ts`

**优先级4：音乐系统**
- [ ] 迁移音乐相关文件 → `音乐/`

### Phase 2: 新系统开发（第2-4周）

按照新架构开发：
- [ ] 存档管理系统（酒馆变量适配）
- [ ] 资源同步系统
- [ ] 事件监听系统
- [ ] 服务层（AI服务、场景配置）

### Phase 3: 删除旧代码（第5周）

- [ ] 删除旧的文件夹结构
- [ ] 更新所有导入路径
- [ ] 测试所有功能

---

## 📊 新旧架构对比

| 方面         | 旧架构            | 新架构              | 优势       |
| ------------ | ----------------- | ------------------- | ---------- |
| **命名方式** | 英文混杂          | 纯中文              | ✅ 直观易懂 |
| **代码组织** | 按项目分文件夹    | 按系统分文件夹      | ✅ 职责清晰 |
| **分层**     | 无明确分层        | 服务/界面/类型      | ✅ 易于维护 |
| **扩展性**   | 新增功能=新文件夹 | 新增系统=新子文件夹 | ✅ 结构统一 |
| **代码复用** | 分散在各处        | 集中在服务/组件     | ✅ 高复用性 |
| **类型管理** | 分散在各文件      | 集中在类型文件夹    | ✅ 类型安全 |
| **样式管理** | 分散在各组件      | 全局样式文件夹      | ✅ 样式复用 |

---

## 🎯 重构后的优势

### 1. **开发体验提升**
- ✅ 中文命名，团队协作更顺畅
- ✅ 文件夹结构一目了然
- ✅ 新增功能位置明确

### 2. **代码质量提升**
- ✅ 服务/界面/类型 分离，职责单一
- ✅ 类型集中管理，类型安全
- ✅ 样式复用，减少重复代码

### 3. **维护性提升**
- ✅ 修改某功能只需找到对应系统文件夹
- ✅ Bug定位快速
- ✅ 代码审查更容易

### 4. **扩展性提升**
- ✅ 新增系统只需新建文件夹
- ✅ 遵循统一的三层架构
- ✅ 不会破坏现有结构

### 5. **与酒馆助手集成更优雅**
- ✅ 存档管理系统专门处理酒馆变量
- ✅ 资源同步系统专门处理世界书
- ✅ 事件监听系统专门处理酒馆事件
- ✅ 脚本文件夹独立，易于管理

---

## 📝 命名规范

### 文件夹命名
- ✅ 使用中文
- ✅ 简短明了（2-4个字）
- ✅ 避免歧义

### 文件命名
- ✅ 使用中文
- ✅ 描述清楚文件职责
- ✅ 服务文件以"服务"结尾
- ✅ 类型文件以"类型"结尾
- ✅ 工具文件以"工具"结尾

### 代码命名
- ✅ 变量/函数：驼峰命名（中文拼音或英文）
- ✅ 接口/类型：Pascal命名
- ✅ 常量：全大写 + 下划线

---

## 🚀 立即行动

### 今天完成（第1步）

1. **创建新架构骨架**
   ```bash
   # 创建新的根文件夹
   cd E:\偶像大师\tavern_helper_template\src
   mkdir 偶像大师闪耀色彩-重构
   
   # 创建所有系统文件夹
   cd 偶像大师闪耀色彩-重构
   # ... 创建所有子文件夹
   ```

2. **迁移核心数据**
   - 复制 `all-cards.ts` → `卡牌管理/全部卡牌数据.ts`
   - 创建基础类型定义

3. **更新 webpack 配置**
   - 添加新架构的入口
   - 保持旧架构可运行（平滑过渡）

### 本周完成（第2-3步）

1. **迁移抽卡系统**
2. **迁移图鉴系统**
3. **测试迁移后的功能**

---

**当前状态**: 🟡 等待开始重构  
**预计重构时间**: 1-2周  
**重构完成后**: **代码质量提升 50%，可维护性提升 80%** 🎯



