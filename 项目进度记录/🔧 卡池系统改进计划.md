# 🔧 卡池系统改进计划

## 📊 当前问题诊断

### 1. 卡池数据问题
**问题**:
- 当前使用 `ALL_CARDS`（414张全部卡面）作为卡池
- 应该只使用 "星月夜を歩いて" 卡池的 **172 张**卡

**正确数据** (基于 `C:\Users\33987\Desktop\角色表.txt`):
```
- UP 角色: 1 张 (【絵空靴】杜野凛世)
- UR 卡: 2 张 (【誘爆ハートビート】黛冬優子、【アマテラス】樋口円香)
- SSR 卡: 125 张
- SR 卡: 44 张
- 总计: 172 张
```

**实际显示**:
```
- UR Produce型偶像: 0种 ❌ (应该显示 3种)
- SSR Produce型偶像: 305种 ❌ (应该显示 125种)
- SR Produce型偶像: 106种 ❌ (应该显示 44种)
```

---

### 2. 概率计算问题
**当前配置** (`constants.ts`):
```typescript
export const BASE_RATES = {
  UR: 0.02,  // 2%
  SSR: 0.2,  // 20%
  SR: 0.78,  // 78%
};
```

**实际概率** (基于414张卡):
```
- UR: 2% ÷ 3张 = 每张 0.67%
- SSR: 20% ÷ 305张 = 每张 0.0656%
- SR: 78% ÷ 106张 = 每张 0.7358%
```

**应该的概率** (基于172张卡):
```
- UR: 2% ÷ 3张 = 每张 0.67%
- SSR: 20% ÷ 125张 = 每张 0.16%
- SR: 78% ÷ 44张 = 每张 1.77%
```

---

### 3. 系统架构问题
**当前架构**:
```
抽卡系统 -> 直接使用 ALL_CARDS (414张)
```

**缺少的功能**:
- ❌ 没有卡池管理系统
- ❌ 无法切换不同卡池
- ❌ 卡池数据硬编码在代码中
- ❌ 无法动态加载新卡池

---

## 🎯 改进方案

### 阶段 1: 创建卡池系统基础架构

#### 1.1 定义卡池类型系统
**文件**: `src/偶像大师闪耀色彩-gacha/types/pool.ts`
```typescript
export interface GachaPool {
  id: string;                    // 卡池ID
  name: string;                  // 卡池名称
  description: string;           // 卡池描述
  pickupCard: RealCard;          // UP角色
  cards: RealCard[];             // 所有可抽取卡片
  thumbnailUrl: string;          // 缩略图URL
  backgroundUrl: string;         // 背景图URL
  startDate: string;             // 开始时间
  endDate: string;               // 结束时间
  status: 'active' | 'upcoming' | 'expired'; // 卡池状态
}

export interface PoolStats {
  total: number;
  ur: number;
  ssr: number;
  sr: number;
}
```

#### 1.2 创建卡池管理器
**文件**: `src/偶像大师闪耀色彩-gacha/pool-manager.ts`
```typescript
import { STARRY_NIGHT_POOL } from './data/pools/starry-night';

// 所有可用卡池
const AVAILABLE_POOLS = [
  STARRY_NIGHT_POOL,
  // 未来的卡池...
];

// 获取当前活动卡池
export function getCurrentPool(): GachaPool {
  return STARRY_NIGHT_POOL;
}

// 获取卡池统计
export function getPoolStats(pool: GachaPool): PoolStats {
  // ...
}
```

---

### 阶段 2: 重新生成 "星月夜を歩いて" 卡池数据

#### 2.1 创建卡池数据生成脚本
**目标**: 从 `角色表.txt` 生成准确的卡池数据

**输入**: `C:\Users\33987\Desktop\角色表.txt`
**输出**: `src/偶像大师闪耀色彩-gacha/data/pools/starry-night.ts`

**数据结构**:
```typescript
export const STARRY_NIGHT_POOL: GachaPool = {
  id: 'starry-night',
  name: '星月夜を歩いて',
  description: '【絵空靴】杜野凛世 期间限定',
  pickupCard: {
    fullName: '【絵空靴】杜野凛世',
    // ...
    rarity: 'UR',
    isPickup: true, // ⭐ 关键标记
  },
  cards: [
    // 2张常驻UR
    { fullName: '【誘爆ハートビート】黛冬優子', rarity: 'UR', ... },
    { fullName: '【アマテラス】樋口円香', rarity: 'UR', ... },
    // 125张SSR
    // 44张SR
  ],
  // ...
};
```

#### 2.2 数据匹配策略
1. 解析 `角色表.txt` 获取卡名列表
2. 从 `ALL_CARDS` 中查找匹配的卡片
3. 设置正确的 `rarity` 和 `isPickup` 标记
4. 生成最终的卡池数据文件

---

### 阶段 3: 修改抽卡逻辑

#### 3.1 更新 `gacha-core-real.ts`
**修改前**:
```typescript
const AVAILABLE_UR_CARDS: RealCard[] = ALL_CARDS.filter(card => card.rarity === 'UR');
const AVAILABLE_SSR_CARDS: RealCard[] = ALL_CARDS.filter(card => card.rarity === 'SSR');
const AVAILABLE_SR_CARDS: RealCard[] = ALL_CARDS.filter(card => card.rarity === 'SR');
```

**修改后**:
```typescript
import { getCurrentPool } from './pool-manager';

// 从当前卡池获取卡片
const currentPool = getCurrentPool();
const ALL_POOL_CARDS = [currentPool.pickupCard, ...currentPool.cards];

const AVAILABLE_UR_CARDS: RealCard[] = ALL_POOL_CARDS.filter(card => card.rarity === 'UR');
const AVAILABLE_SSR_CARDS: RealCard[] = ALL_POOL_CARDS.filter(card => card.rarity === 'SSR');
const AVAILABLE_SR_CARDS: RealCard[] = ALL_POOL_CARDS.filter(card => card.rarity === 'SR');
```

#### 3.2 UP角色概率提升
**目标**: UP 角色在 UR 池中有更高概率

**实现**:
```typescript
function pickCardFromPool(rarity: Rarity): RealCard {
  if (rarity === 'UR') {
    // 50% 概率抽到 UP 角色
    if (Math.random() < 0.5) {
      return currentPool.pickupCard;
    }
    // 50% 概率从其他 UR 中抽取
    const otherUR = AVAILABLE_UR_CARDS.filter(card => !card.isPickup);
    return otherUR[Math.floor(Math.random() * otherUR.length)];
  }
  // SSR 和 SR 正常随机
  // ...
}
```

---

### 阶段 4: 更新 UI 显示

#### 4.1 修复概率显示
**文件**: `src/偶像大师闪耀色彩-gacha/app.vue`

**修改前**:
```vue
<!-- 显示所有414张卡的概率 -->
<div>SSR Produce型偶像 (305种)</div>
```

**修改后**:
```vue
<!-- 显示当前卡池的172张卡的概率 -->
<div>SSR Produce型偶像 ({{ poolStats.ssr }}种)</div>

<script setup>
const poolStats = computed(() => {
  const pool = getCurrentPool();
  return getPoolStats(pool);
});
</script>
```

#### 4.2 添加卡池信息展示
```vue
<div class="pool-info">
  <h3>{{ currentPool.name }}</h3>
  <p>{{ currentPool.description }}</p>
  <div class="pool-stats">
    <span>UR: {{ poolStats.ur }}种</span>
    <span>SSR: {{ poolStats.ssr }}种</span>
    <span>SR: {{ poolStats.sr }}种</span>
    <span>总计: {{ poolStats.total }}种</span>
  </div>
</div>
```

---

## ✅ 验证清单

- [ ] 卡池数据正确（172张）
- [ ] UR 显示为 3 种（1 UP + 2 常驻）
- [ ] SSR 显示为 125 种
- [ ] SR 显示为 44 种
- [ ] UP 角色有 isPickup 标记
- [ ] 抽卡只从当前卡池抽取
- [ ] 概率计算基于 172 张卡
- [ ] UI 显示正确的数量
- [ ] 能够切换不同卡池（预留功能）

---

## 📋 实施步骤

### Step 1: 创建生成脚本
```bash
node generate-starry-night-pool.cjs
```

### Step 2: 创建卡池系统文件
- `src/偶像大师闪耀色彩-gacha/types/pool.ts`
- `src/偶像大师闪耀色彩-gacha/pool-manager.ts`

### Step 3: 更新抽卡逻辑
- 修改 `gacha-core-real.ts`

### Step 4: 更新 UI
- 修改 `app.vue`

### Step 5: 测试验证
- 运行 `npm run build`
- 测试抽卡功能
- 验证概率显示
- 检查卡池数据

---

## 🎯 预期结果

**修复后的显示**:
```
UR Produce型偶像 (3种)
├─ 【絵空靴】杜野凛世 (UP) - 1.0%
├─ 【誘爆ハートビート】黛冬優子 - 0.5%
└─ 【アマテラス】樋口円香 - 0.5%

SSR Produce型偶像 (125种)
├─ 每张卡概率: 0.16%
└─ 总概率: 20%

SR Produce型偶像 (44种)
├─ 每张卡概率: 1.77%
└─ 总概率: 78%

总卡池: 172 张
```

---

## 🚀 扩展性考虑

### 未来卡池支持
- 每个卡池独立的 `.ts` 文件
- 卡池管理器自动加载所有卡池
- 支持多卡池同时开放
- 卡池切换 UI

### 数据驱动
- 卡池数据从配置文件生成
- 支持热更新卡池
- 版本控制和回滚

---

**下一步**: 开始实施 Step 1 - 创建卡池数据生成脚本












